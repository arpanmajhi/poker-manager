<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Manager Pro</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f0f0; }
        .container { max-width: 1200px; margin: auto; }
        .nav-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-item { padding: 10px 20px; background: #333; color: white; cursor: pointer; border-radius: 5px; }
        .nav-item:hover { background: #555; }
        .section { display: none; background: white; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .section.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background: #f5f5f5; cursor: pointer; }
        button { padding: 5px 10px; margin: 2px; background: #007BFF; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .delete-btn { background: #DC3545; }
        .delete-btn:hover { background: #b02a37; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 15% auto; padding: 20px; width: 80%; max-width: 500px; border-radius: 5px; }
        .notification { position: fixed; top: 10px; right: 10px; padding: 10px 20px; border-radius: 5px; display: none; }
        .notification.success { background: #28A745; color: white; }
        .notification.error { background: #DC3545; color: white; }
        .positive { color: #28A745; }
        .negative { color: #DC3545; }
        input, select { padding: 5px; margin: 5px 0; width: calc(100% - 12px); }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <div class="nav-item" onclick="showSection('dashboard')">Dashboard</div>
            <div class="nav-item" onclick="showSection('tournaments')">Tournaments</div>
            <div class="nav-item" onclick="showSection('transactions')">Transactions</div>
            <div class="nav-item" onclick="showSection('results')">Results</div>
            <div class="nav-item" onclick="showSection('manage')">Manage</div>
        </div>

        <div id="dashboard" class="section active">
            <h2>Dashboard</h2>
            <div id="overall-stats"></div>
            <div id="per-site-stats"></div>
        </div>

        <div id="tournaments" class="section">
            <h2>Tournaments</h2>
            <button onclick="openAddTournamentModal()">Add Tournament</button>
            <button class="delete-btn" onclick="clearUncompletedTournaments()">Clear Uncompleted</button>
            <table id="tournaments-table">
                <thead>
                    <tr>
                        <th onclick="sortTable('tournaments-table', 0)">Date</th>
                        <th>Status</th>
                        <th>Name</th>
                        <th>Site</th>
                        <th>Buy-in</th>
                        <th>GTD</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="transactions" class="section">
            <h2>Transactions</h2>
            <button onclick="openAddTransactionModal()">Add Transaction</button>
            <table id="transactions-table">
                <thead>
                    <tr>
                        <th onclick="sortTable('transactions-table', 0)">Date</th>
                        <th>Site</th>
                        <th>Deposit</th>
                        <th>Withdrawal</th>
                        <th>Tax</th>
                        <th>Tournament Money</th>
                        <th>Bonuses</th>
                        <th>Adjustments</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="results" class="section">
            <h2>Results</h2>
            <table id="results-table">
                <thead>
                    <tr>
                        <th onclick="sortTable('results-table', 0)">Date</th>
                        <th>Name</th>
                        <th>Site</th>
                        <th>Buy-in</th>
                        <th>GTD</th>
                        <th>Entries</th>
                        <th>Finish</th>
                        <th>Cashout</th>
                        <th>Profit/Loss</th>
                        <th>ROI</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="manage" class="section">
            <h2>Manage</h2>
            <h3>Poker Sites</h3>
            <button onclick="openAddSiteModal()">Add Site</button>
            <div id="sites-list"></div>
            <h3>Game Configurations</h3>
            <div id="game-types"></div>
            <div id="formats"></div>
            <div id="structures"></div>
            <h3>Data</h3>
            <button onclick="exportData()">Export Data (JSON)</button>
            <button onclick="document.getElementById('import-file').click()">Import Data (JSON)</button>
            <input type="file" id="import-file" style="display:none" onchange="importData(event)">
            <button onclick="exportTournamentsCSV()">Export Tournaments CSV</button>
            <button onclick="exportTransactionsCSV()">Export Transactions CSV</button>
            <input type="file" id="import-tournaments" style="display:none" accept=".csv" onchange="importTournamentsCSV(event)">
            <button onclick="document.getElementById('import-tournaments').click()">Import Tournaments CSV</button>
            <input type="file" id="import-transactions" style="display:none" accept=".csv" onchange="importTransactionsCSV(event)">
            <button onclick="document.getElementById('import-transactions').click()">Import Transactions CSV</button>
        </div>

        <div id="modal" class="modal">
            <div class="modal-content" id="modal-content"></div>
        </div>

        <div id="notification" class="notification"></div>
    </div>

    <script>
        let pokerSites = [];
        let tournaments = [];
        let transactions = [];
        let gameTypes = ["NLH", "PLO"];
        let formats = ["Regular", "PKO"];
        let structures = ["Regular", "Turbo"];
        let siteIdCounter = 0;
        let tournamentIdCounter = 0;
        let transactionIdCounter = 0;
        const baseCurrency = "INR";
        const currencies = ["INR", "USD", "EUR", "GBP"];
        const exchangeRates = { "USD": 80, "EUR": 90, "GBP": 100, "INR": 1 };
        const transactionTypeMapping = {
            'Deposit': 'deposit',
            'Withdrawal': 'withdrawal',
            'Others': 'otherAdjustments',
            'Bonus': 'instantBonus'
        };

        // Utility Functions
        function formatCurrency(amount, currency) {
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency }).format(amount);
        }

        function parseCurrency(str) {
            if (!str) return 0;
            const numStr = str.replace(/[^0-9.-]+/g, '');
            return parseFloat(numStr) || 0;
        }

        function convertToBase(amount, currency) {
            return amount * (exchangeRates[currency] || 1);
        }

        function getSiteById(siteId) {
            return pokerSites.find(site => site.id === siteId);
        }

        function getOrCreateSiteId(name, currency = 'INR') {
            let site = pokerSites.find(s => s.name.toLowerCase() === name.toLowerCase());
            if (!site) {
                site = { id: siteIdCounter++, name, currency, bankroll: 0 };
                pokerSites.push(site);
            }
            return site.id;
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => notification.style.display = 'none', 3000);
        }

        // Data Persistence
        function saveData() {
            const data = {
                pokerSites, tournaments, transactions,
                gameTypes, formats, structures,
                siteIdCounter, tournamentIdCounter, transactionIdCounter
            };
            localStorage.setItem('pokerManagerData', JSON.stringify(data));
        }

        function loadData() {
            const data = JSON.parse(localStorage.getItem('pokerManagerData'));
            if (data) {
                pokerSites = data.pokerSites;
                tournaments = data.tournaments;
                transactions = data.transactions;
                gameTypes = data.gameTypes;
                formats = data.formats;
                structures = data.structures;
                siteIdCounter = data.siteIdCounter;
                tournamentIdCounter = data.tournamentIdCounter;
                transactionIdCounter = data.transactionIdCounter;
            }
            updateUI();
        }

        // UI Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            updateUI();
        }

        // Modals
        function openModal(content) {
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // Dashboard
        function updateDashboard() {
            const overall = calculateOverallStats();
            const perSite = calculatePerSiteStats();
            document.getElementById('overall-stats').innerHTML = `
                <h3>Overall Performance</h3>
                <p>Total Bankroll: ${formatCurrency(overall.bankroll, baseCurrency)}</p>
                <p>Profit/Loss: <span class="${overall.profitLoss >= 0 ? 'positive' : 'negative'}">${formatCurrency(overall.profitLoss, baseCurrency)}</span></p>
                <p>Average Buy-in: ${formatCurrency(overall.avgBuyIn, baseCurrency)}</p>
                <p>Total Tournaments: ${overall.totalTournaments}</p>
                <p>ROI: ${overall.roi.toFixed(2)}%</p>
            `;
            document.getElementById('per-site-stats').innerHTML = perSite.map(site => `
                <details>
                    <summary>${site.name} (Bankroll: ${formatCurrency(site.bankroll, site.currency)})</summary>
                    <p>Profit/Loss: <span class="${site.profitLoss >= 0 ? 'positive' : 'negative'}">${formatCurrency(site.profitLoss, site.currency)}</span></p>
                    <p>Avg Buy-in: ${formatCurrency(site.avgBuyIn, site.currency)}</p>
                    <p>Tournaments: ${site.totalTournaments}</p>
                    <p>ROI: ${site.roi.toFixed(2)}%</p>
                    <p>Deposits: ${formatCurrency(site.transactions.deposits, site.currency)}</p>
                    <p>Withdrawals: ${formatCurrency(site.transactions.withdrawals, site.currency)}</p>
                    <p>Taxes: ${formatCurrency(site.transactions.taxes, site.currency)}</p>
                    <p>Bonuses: ${formatCurrency(site.transactions.bonuses, site.currency)}</p>
                    <p>Adjustments: ${formatCurrency(site.transactions.adjustments, site.currency)}</p>
                </details>
            `).join('');
        }

        function calculateOverallStats() {
            const completed = tournaments.filter(t => t.completed);
            const totalBankroll = pokerSites.reduce((sum, site) => sum + convertToBase(site.bankroll, site.currency), 0);
            const profitLoss = completed.reduce((sum, t) => {
                const site = getSiteById(t.siteId);
                const cashout = (t.itmCashout || 0) + (t.bountyCashout || 0);
                const cost = t.buyIn + (t.addOnCosts || 0);
                return sum + convertToBase(cashout - cost, site.currency);
            }, 0);
            const totalBuyIns = completed.reduce((sum, t) => sum + convertToBase(t.buyIn, getSiteById(t.siteId).currency), 0);
            return {
                bankroll: totalBankroll,
                profitLoss,
                avgBuyIn: completed.length ? totalBuyIns / completed.length : 0,
                totalTournaments: completed.length,
                roi: totalBuyIns ? (profitLoss / totalBuyIns) * 100 : 0
            };
        }

        function calculatePerSiteStats() {
            return pokerSites.map(site => {
                const siteTournaments = tournaments.filter(t => t.siteId === site.id && t.completed);
                const profitLoss = siteTournaments.reduce((sum, t) => {
                    const cashout = (t.itmCashout || 0) + (t.bountyCashout || 0);
                    const cost = t.buyIn + (t.addOnCosts || 0);
                    return sum + (cashout - cost);
                }, 0);
                const totalBuyIns = siteTournaments.reduce((sum, t) => sum + t.buyIn, 0);
                const siteTransactions = transactions.filter(t => t.siteId === site.id);
                return {
                    name: site.name,
                    currency: site.currency,
                    bankroll: site.bankroll,
                    profitLoss,
                    avgBuyIn: siteTournaments.length ? totalBuyIns / siteTournaments.length : 0,
                    totalTournaments: siteTournaments.length,
                    roi: totalBuyIns ? (profitLoss / totalBuyIns) * 100 : 0,
                    transactions: {
                        deposits: siteTransactions.reduce((sum, t) => sum + (t.deposit || 0), 0),
                        withdrawals: siteTransactions.reduce((sum, t) => sum + (t.withdrawal || 0), 0),
                        taxes: siteTransactions.reduce((sum, t) => sum + (t.tax || 0), 0),
                        bonuses: siteTransactions.reduce((sum, t) => sum + ((t.instantBonus || 0) + (t.lockedBonus || 0)), 0),
                        adjustments: siteTransactions.reduce((sum, t) => sum + (t.otherAdjustments || 0), 0)
                    }
                };
            });
        }

        // Tournaments
        function openAddTournamentModal() {
            if (!pokerSites.length) {
                showNotification("Please add a poker site first.", "error");
                return;
            }
            openModal(`
                <h3>Add Tournament</h3>
                <input type="datetime-local" id="t-date">
                <select id="t-site">${pokerSites.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select>
                <input type="number" id="t-buyin" placeholder="Buy-in" step="0.01" min="0">
                <input type="number" id="t-gtd" placeholder="GTD" step="0.01" min="0">
                <input type="number" id="t-discount" placeholder="Discount" step="0.01" min="0">
                <select id="t-gameType">${gameTypes.map(gt => `<option>${gt}</option>`).join('')}</select>
                <select id="t-format">${formats.map(f => `<option>${f}</option>`).join('')}</select>
                <select id="t-structure">${structures.map(s => `<option>${s}</option>`).join('')}</select>
                <button onclick="addTournament()">Add</button>
                <button onclick="closeModal()">Cancel</button>
            `);
        }

        function addTournament() {
            const date = new Date(document.getElementById('t-date').value);
            const siteId = document.getElementById('t-site').value;
            const buyIn = parseFloat(document.getElementById('t-buyin').value) || 0;
            const gtd = parseFloat(document.getElementById('t-gtd').value) || 0;
            const discount = parseFloat(document.getElementById('t-discount').value) || 0;
            const gameType = document.getElementById('t-gameType').value;
            const format = document.getElementById('t-format').value;
            const structure = document.getElementById('t-structure').value;
            if (!date || !buyIn) {
                showNotification("Date and Buy-in are required.", "error");
                return;
            }
            const site = getSiteById(siteId);
            const dayAbbr = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"][date.getDay()];
            const name = `${dayAbbr}-${site.name}-${formatCurrency(buyIn, site.currency)}`;
            tournaments.push({
                id: tournamentIdCounter++,
                date: date.toISOString(),
                siteId,
                buyIn,
                gtd,
                discount,
                gameType,
                format,
                structure,
                name,
                completed: false
            });
            saveData();
            closeModal();
            showNotification("Tournament added.", "success");
            updateUI();
        }

        function openUpdateTournamentModal(id) {
            const t = tournaments.find(t => t.id === id);
            openModal(`
                <h3>Update Results</h3>
                <p>${t.name}</p>
                <input type="number" id="t-entries" placeholder="Entries" min="0" value="${t.entries || ''}">
                <input type="number" id="t-finish" placeholder="Finish Position" min="1" value="${t.finishPosition || ''}">
                <input type="number" id="t-itm" placeholder="ITM Cashout" step="0.01" min="0" value="${t.itmCashout || ''}">
                <input type="number" id="t-bounty" placeholder="Bounty Cashout" step="0.01" min="0" value="${t.bountyCashout || ''}">
                <input type="number" id="t-addon" placeholder="Add-on Costs" step="0.01" min="0" value="${t.addOnCosts || ''}">
                <input type="number" id="t-money" placeholder="Tournament Money Won" step="0.01" min="0" value="${t.tournamentMoneyWon || ''}">
                <button onclick="updateTournament(${id})">Update</button>
                <button onclick="closeModal()">Cancel</button>
            `);
        }

        function updateTournament(id) {
            const t = tournaments.find(t => t.id === id);
            t.entries = parseInt(document.getElementById('t-entries').value) || 0;
            t.finishPosition = parseInt(document.getElementById('t-finish').value) || 0;
            t.itmCashout = parseFloat(document.getElementById('t-itm').value) || 0;
            t.bountyCashout = parseFloat(document.getElementById('t-bounty').value) || 0;
            t.addOnCosts = parseFloat(document.getElementById('t-addon').value) || 0;
            t.tournamentMoneyWon = parseFloat(document.getElementById('t-money').value) || 0;
            t.completed = true;
            saveData();
            closeModal();
            showNotification("Tournament updated.", "success");
            updateUI();
        }

        function deleteTournament(id) {
            if (confirm("Are you sure you want to delete this tournament?")) {
                tournaments = tournaments.filter(t => t.id !== id);
                saveData();
                showNotification("Tournament deleted.", "success");
                updateUI();
            }
        }

        function clearUncompletedTournaments() {
            if (confirm("Are you sure you want to clear all uncompleted tournaments?")) {
                tournaments = tournaments.filter(t => t.completed);
                saveData();
                showNotification("Uncompleted tournaments cleared.", "success");
                updateUI();
            }
        }

        function getTournamentStatus(t) {
            const now = new Date();
            const date = new Date(t.date);
            const diff = (date - now) / 60000; // minutes
            if (t.completed) return "Completed";
            if (diff > 30) return "Upcoming";
            if (diff > 0) return "Starting Soon";
            if (diff > -5) return "Just Started";
            return "In Progress";
        }

        // Transactions
        function openAddTransactionModal() {
            if (!pokerSites.length) {
                showNotification("Please add a poker site first.", "error");
                return;
            }
            openModal(`
                <h3>Add Transaction</h3>
                <input type="datetime-local" id="tr-date">
                <select id="tr-site">${pokerSites.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select>
                <input type="number" id="tr-deposit" placeholder="Deposit" step="0.01" min="0">
                <input type="number" id="tr-withdrawal" placeholder="Withdrawal" step="0.01" min="0">
                <input type="number" id="tr-tax" placeholder="Tax" step="0.01" min="0">
                <input type="number" id="tr-tmoney" placeholder="Tournament Money" step="0.01" min="0">
                <input type="number" id="tr-ibonus" placeholder="Instant Bonus" step="0.01" min="0">
                <input type="number" id="tr-lbonus" placeholder="Locked Bonus" step="0.01" min="0">
                <input type="number" id="tr-adjust" placeholder="Other Adjustments" step="0.01">
                <button onclick="addTransaction()">Add</button>
                <button onclick="closeModal()">Cancel</button>
            `);
        }

        function addTransaction() {
            const date = new Date(document.getElementById('tr-date').value);
            const siteId = document.getElementById('tr-site').value;
            const deposit = parseFloat(document.getElementById('tr-deposit').value) || 0;
            const withdrawal = parseFloat(document.getElementById('tr-withdrawal').value) || 0;
            const tax = parseFloat(document.getElementById('tr-tax').value) || 0;
            const tmoney = parseFloat(document.getElementById('tr-tmoney').value) || 0;
            const ibonus = parseFloat(document.getElementById('tr-ibonus').value) || 0;
            const lbonus = parseFloat(document.getElementById('tr-lbonus').value) || 0;
            const adjust = parseFloat(document.getElementById('tr-adjust').value) || 0;
            if (!date) {
                showNotification("Date is required.", "error");
                return;
            }
            const site = getSiteById(siteId);
            const change = deposit - withdrawal - tax + tmoney + ibonus + lbonus + adjust;
            site.bankroll = (site.bankroll || 0) + change;
            transactions.push({
                id: transactionIdCounter++,
                date: date.toISOString(),
                siteId,
                deposit,
                withdrawal,
                tax,
                tournamentMoney: tmoney,
                instantBonus: ibonus,
                lockedBonus: lbonus,
                otherAdjustments: adjust
            });
            saveData();
            closeModal();
            showNotification("Transaction added.", "success");
            updateUI();
        }

        // Results
        function updateResults() {
            const tbody = document.querySelector('#results-table tbody');
            tbody.innerHTML = tournaments.filter(t => t.completed).map(t => {
                const site = getSiteById(t.siteId);
                const cashout = (t.itmCashout || 0) + (t.bountyCashout || 0);
                const cost = t.buyIn + (t.addOnCosts || 0);
                const profitLoss = cashout - cost;
                const roi = cost ? (profitLoss / cost) * 100 : 0;
                return `
                    <tr>
                        <td>${new Date(t.date).toLocaleDateString()}</td>
                        <td>${t.name}</td>
                        <td>${site.name}</td>
                        <td>${formatCurrency(t.buyIn, site.currency)}</td>
                        <td>${formatCurrency(t.gtd, site.currency)}</td>
                        <td>${t.entries || '-'}</td>
                        <td>${t.finishPosition || '-'}</td>
                        <td>${formatCurrency(cashout, site.currency)}</td>
                        <td class="${profitLoss >= 0 ? 'positive' : 'negative'}">${formatCurrency(profitLoss, site.currency)}</td>
                        <td>${roi.toFixed(2)}%</td>
                        <td>
                            <button onclick="openUpdateTournamentModal(${t.id})">Edit</button>
                            <button class="delete-btn" onclick="deleteTournament(${t.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Manage
        function openAddSiteModal() {
            openModal(`
                <h3>Add Poker Site</h3>
                <input type="text" id="s-name" placeholder="Site Name">
                <select id="s-currency">${currencies.map(c => `<option>${c}</option>`).join('')}</select>
                <button onclick="addSite()">Add</button>
                <button onclick="closeModal()">Cancel</button>
            `);
        }

        function addSite() {
            const name = document.getElementById('s-name').value.trim();
            const currency = document.getElementById('s-currency').value;
            if (!name) {
                showNotification("Site name is required.", "error");
                return;
            }
            pokerSites.push({ id: siteIdCounter++, name, currency, bankroll: 0 });
            saveData();
            closeModal();
            showNotification("Site added.", "success");
            updateUI();
        }

        function deleteSite(id) {
            if (tournaments.some(t => t.siteId === id) || transactions.some(t => t.siteId === id)) {
                showNotification("Cannot delete site with linked tournaments or transactions.", "error");
                return;
            }
            if (confirm("Are you sure you want to delete this site?")) {
                pokerSites = pokerSites.filter(s => s.id !== id);
                saveData();
                showNotification("Site deleted.", "success");
                updateUI();
            }
        }

        function updateManage() {
            document.getElementById('sites-list').innerHTML = pokerSites.map(s => `
                <p>${s.name} (${s.currency}) <button class="delete-btn" onclick="deleteSite(${s.id})">Delete</button></p>
            `).join('');
            document.getElementById('game-types').innerHTML = `<h4>Game Types</h4>${gameTypes.map(gt => `
                <p>${gt} <button class="delete-btn" onclick="deleteConfig('gameTypes', '${gt}')">Delete</button></p>
            `).join('')}<button onclick="addConfig('gameTypes')">Add</button>`;
            document.getElementById('formats').innerHTML = `<h4>Formats</h4>${formats.map(f => `
                <p>${f} <button class="delete-btn" onclick="deleteConfig('formats', '${f}')">Delete</button></p>
            `).join('')}<button onclick="addConfig('formats')">Add</button>`;
            document.getElementById('structures').innerHTML = `<h4>Structures</h4>${structures.map(s => `
                <p>${s} <button class="delete-btn" onclick="deleteConfig('structures', '${s}')">Delete</button></p>
            `).join('')}<button onclick="addConfig('structures')">Add</button>`;
        }

        function addConfig(type) {
            const value = prompt(`Enter new ${type.slice(0, -1)}:`);
            if (value && !window[type].includes(value)) {
                window[type].push(value);
                saveData();
                updateUI();
            }
        }

        function deleteConfig(type, value) {
            if (confirm(`Delete ${value}?`)) {
                window[type] = window[type].filter(v => v !== value);
                saveData();
                updateUI();
            }
        }

        function exportData() {
            const data = JSON.stringify({ pokerSites, tournaments, transactions, gameTypes, formats, structures, siteIdCounter, tournamentIdCounter, transactionIdCounter });
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'poker_manager_data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            if (confirm("Importing will overwrite existing data. Continue?")) {
                const file = event.target.files[0];
                const reader = new FileReader();
                reader.onload = () => {
                    const data = JSON.parse(reader.result);
                    Object.assign(window, data);
                    saveData();
                    showNotification("Data imported.", "success");
                    updateUI();
                };
                reader.readAsText(file);
            }
        }

        // CSV Export and Import
        function exportTournamentsCSV() {
            const completedTournaments = tournaments.filter(t => t.completed);
            const headers = ['Date', 'Time', 'Site', 'Buyin', 'Discount', 'Total Entries', 'Total Buyin', 'Bounty', 'Cashout', 'Place', 'Profit/Losses', 'Actual Discount'];
            const rows = completedTournaments.map(t => {
                const site = getSiteById(t.siteId);
                const date = new Date(t.date);
                const totalEntries = t.addOnCosts > 0 ? Math.round(1 + t.addOnCosts / t.buyIn) : 1;
                const totalBuyin = t.buyIn * totalEntries;
                const cashout = (t.itmCashout || 0) + (t.bountyCashout || 0);
                const profitLoss = cashout - totalBuyin;
                return [
                    date.toLocaleDateString(),
                    date.toLocaleTimeString(),
                    site.name,
                    formatCurrency(t.buyIn, site.currency),
                    t.discount ? formatCurrency(t.discount, site.currency) : '',
                    totalEntries,
                    formatCurrency(totalBuyin, site.currency),
                    t.bountyCashout ? formatCurrency(t.bountyCashout, site.currency) : '',
                    t.itmCashout ? formatCurrency(t.itmCashout, site.currency) : '',
                    t.finishPosition || '',
                    formatCurrency(profitLoss, site.currency),
                    ''
                ].join(',');
            });
            const csv = [headers.join(','), ...rows].join('\n');
            downloadCSV(csv, 'tournaments.csv');
        }

        function exportTransactionsCSV() {
            const headers = ['Date', 'Transaction', 'Amount', 'Site', 'Notes'];
            const rows = transactions.map(t => {
                const site = getSiteById(t.siteId);
                let transactionType = '';
                let amount = 0;
                if (t.deposit > 0) {
                    transactionType = 'Deposit';
                    amount = t.deposit;
                } else if (t.withdrawal > 0) {
                    transactionType = 'Withdrawal';
                    amount = t.withdrawal;
                } else if (t.tournamentMoney > 0) {
                    transactionType = 'Tournament Money';
                    amount = t.tournamentMoney;
                } else if (t.instantBonus > 0) {
                    transactionType = 'Bonus';
                    amount = t.instantBonus;
                } else if (t.lockedBonus > 0) {
                    transactionType = 'Locked Bonus';
                    amount = t.lockedBonus;
                } else if (t.otherAdjustments != 0) {
                    transactionType = 'Others';
                    amount = t.otherAdjustments;
                }
                const date = new Date(t.date).toLocaleDateString();
                return [
                    date,
                    transactionType,
                    formatCurrency(amount, site.currency),
                    site.name,
                    ''
                ].join(',');
            });
            const csv = [headers.join(','), ...rows].join('\n');
            downloadCSV(csv, 'transactions.csv');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function parseCSV(csvString) {
            const lines = csvString.split('\n').filter(line => line.trim() !== '');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim());
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index];
                });
                return obj;
            });
            return data;
        }

        function importTournamentsCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                const csvString = reader.result;
                const data = parseCSV(csvString);
                data.forEach(row => {
                    try {
                        const dateStr = row['Date'] + ' ' + row['Time'];
                        const date = new Date(dateStr);
                        if (isNaN(date)) throw new Error('Invalid date');
                        const siteName = row['Site'];
                        const siteId = getOrCreateSiteId(siteName);
                        const buyIn = parseCurrency(row['Buyin']);
                        const discount = row['Discount'] ? parseCurrency(row['Discount']) : 0;
                        const totalEntries = parseInt(row['Total Entries']) || 1;
                        const bountyCashout = row['Bounty'] ? parseCurrency(row['Bounty']) : 0;
                        const itmCashout = row['Cashout'] ? parseCurrency(row['Cashout']) : 0;
                        const finishPosition = row['Place'] ? parseInt(row['Place']) : null;
                        const addOnCosts = totalEntries > 1 ? (totalEntries - 1) * buyIn : 0;
                        const tournament = {
                            id: tournamentIdCounter++,
                            date: date.toISOString(),
                            siteId,
                            buyIn,
                            discount,
                            gtd: 0,
                            gameType: 'NLH',
                            format: 'Regular',
                            structure: 'Regular',
                            name: generateTournamentName(date, siteName, buyIn),
                            completed: true,
                            entries: totalEntries,
                            finishPosition,
                            itmCashout,
                            bountyCashout,
                            addOnCosts
                        };
                        tournaments.push(tournament);
                    } catch (error) {
                        console.error('Error importing tournament:', error);
                    }
                });
                saveData();
                showNotification('Tournaments imported successfully.', 'success');
                updateUI();
            };
            reader.readAsText(file);
        }

        function importTransactionsCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                const csvString = reader.result;
                const data = parseCSV(csvString);
                data.forEach(row => {
                    try {
                        const date = new Date(row['Date']);
                        if (isNaN(date)) throw new Error('Invalid date');
                        const siteName = row['Site'];
                        const siteId = getOrCreateSiteId(siteName);
                        const transactionType = row['Transaction'];
                        const amount = parseCurrency(row['Amount']);
                        const field = transactionTypeMapping[transactionType];
                        if (!field) throw new Error('Unknown transaction type');
                        const transaction = {
                            id: transactionIdCounter++,
                            date: date.toISOString(),
                            siteId,
                            [field]: amount
                        };
                        transactions.push(transaction);
                        const site = getSiteById(siteId);
                        if (field === 'deposit') {
                            site.bankroll += amount;
                        } else if (field === 'withdrawal') {
                            site.bankroll -= amount;
                        } else {
                            site.bankroll += amount;
                        }
                    } catch (error) {
                        console.error('Error importing transaction:', error);
                    }
                });
                saveData();
                showNotification('Transactions imported successfully.', 'success');
                updateUI();
            };
            reader.readAsText(file);
        }

        function generateTournamentName(date, siteName, buyIn) {
            const dayAbbr = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"][date.getDay()];
            return `${dayAbbr}-${siteName}-${formatCurrency(buyIn, 'INR')}`;
        }

        // Table Sorting
        function sortTable(tableId, col) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const dir = table.dataset.sortDir === 'asc' ? 'desc' : 'asc';
            table.dataset.sortDir = dir;
            rows.sort((a, b) => {
                let aVal = a.cells[col].textContent;
                let bVal = b.cells[col].textContent;
                if (!isNaN(parseFloat(aVal)) && !isNaN(parseFloat(bVal))) {
                    aVal = parseFloat(aVal.replace(/[^\d.-]/g, ''));
                    bVal = parseFloat(bVal.replace(/[^\d.-]/g, ''));
                }
                return dir === 'asc' ? aVal > bVal ? 1 : -1 : aVal < bVal ? 1 : -1;
            });
            rows.forEach(row => tbody.appendChild(row));
        }

        // Update UI
        function updateUI() {
            const activeSection = document.querySelector('.section.active');
            if (activeSection.id === 'dashboard') updateDashboard();
            else if (activeSection.id === 'tournaments') {
                const tbody = document.querySelector('#tournaments-table tbody');
                tbody.innerHTML = tournaments.filter(t => !t.completed).map(t => {
                    const site = getSiteById(t.siteId);
                    return `
                        <tr>
                            <td>${new Date(t.date).toLocaleString()}</td>
                            <td>${getTournamentStatus(t)}</td>
                            <td>${t.name}</td>
                            <td>${site.name}</td>
                            <td>${formatCurrency(t.buyIn, site.currency)}</td>
                            <td>${formatCurrency(t.gtd, site.currency)}</td>
                            <td>
                                <button onclick="openUpdateTournamentModal(${t.id})">Update</button>
                                <button class="delete-btn" onclick="deleteTournament(${t.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else if (activeSection.id === 'transactions') {
                const tbody = document.querySelector('#transactions-table tbody');
                tbody.innerHTML = transactions.map(t => {
                    const site = getSiteById(t.siteId);
                    return `
                        <tr>
                            <td>${new Date(t.date).toLocaleDateString()}</td>
                            <td>${site.name}</td>
                            <td class="positive">${formatCurrency(t.deposit || 0, site.currency)}</td>
                            <td class="negative">${formatCurrency(t.withdrawal || 0, site.currency)}</td>
                            <td class="negative">${formatCurrency(t.tax || 0, site.currency)}</td>
                            <td class="positive">${formatCurrency(t.tournamentMoney || 0, site.currency)}</td>
                            <td class="positive">${formatCurrency((t.instantBonus || 0) + (t.lockedBonus || 0), site.currency)}</td>
                            <td>${formatCurrency(t.otherAdjustments || 0, site.currency)}</td>
                        </tr>
                    `;
                }).join('');
            } else if (activeSection.id === 'results') updateResults();
            else if (activeSection.id === 'manage') updateManage();
        }

        // Initial Load
        loadData();
        updateUI();
    </script>
</body>
</html>
