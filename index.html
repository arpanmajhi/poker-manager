<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18.3.1/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.24.7/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/2.1.3/24/outline/heroicons.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-primary': '#4f46e5',
                        'brand-secondary': '#6366f1',
                        'gray-950': '#0d1117',
                        'gray-900': '#161b22',
                        'gray-800': '#1e242c',
                        'gray-700': '#2c333c',
                        'gray-600': '#4b5563',
                        'success': '#22c55e',
                        'danger': '#ef4444',
                        'warning': '#f97316',
                    }
                }
            }
        }
    </script>
    <style>
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-content.expanded {
            max-height: 500px;
            transition: max-height 0.5s ease-in;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #161b22; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6366f1; }
    </style>
</head>
<body class="bg-gray-950 text-gray-200 antialiased">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        const EXCHANGE_RATES = { 'INR': 1, 'USD': 83.50, 'EUR': 90.10 };
        const formatCurrency = (amount, currency = 'INR') => {
            try {
                return new Intl.NumberFormat('en-IN', { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount);
            } catch (e) { return `${currency} ${amount.toFixed(2)}`; }
        };
        const getTodayDate = () => new Date().toISOString().split('T')[0];
        const getNowTime = () => new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

        function useLocalStorage(key, initialValue) {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) { console.error(error); return initialValue; }
            });
            const setValue = useCallback((value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) { console.error(error); }
            }, [key, storedValue]);
            return [storedValue, setValue];
        }

        const DEFAULT_POKER_SITES = [{ id: 1, name: 'PokerBaazi', currency: 'INR' }, { id: 2, name: 'GGPoker', currency: 'USD' }];
        const DEFAULT_GAME_TYPES = ['NLH', 'PLO', 'PLO5', 'PLO6'];
        const DEFAULT_GAME_FORMATS = ['Regular', 'PKO', 'Bounty', 'Deepstack', 'Turbo', 'Hyper-Turbo'];
        const DEFAULT_GAME_STRUCTURES = ['Regular', 'Turbo', 'Hyper-Turbo'];
        const APP_DATA_KEYS = ['poker_tournaments', 'poker_transactions', 'poker_sites', 'poker_gameTypes', 'poker_gameFormats', 'poker_gameStructures'];

        const Icon = ({ name, className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
                {name === 'dashboard' && <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h12A2.25 2.25 0 0 0 20.25 14.25V3.75M3.75 3h16.5M3.75 3v.008h.008V3H3.75Zm0 3.75h.008v.008H3.75V6.75Zm0 3.75h.008v.008H3.75v-.008Zm0 3.75h.008v.008H3.75v-.008Zm3.75-3.75h.008v.008H7.5v-.008Zm0 3.75h.008v.008H7.5v-.008Zm3.75-3.75h.008v.008h-.008v-.008Zm0 3.75h.008v.008h-.008v-.008Zm3.75-3.75h.008v.008h-.008v-.008Zm0 3.75h.008v.008h-.008v-.008Z" />}
                {name === 'tournaments' && <path strokeLinecap="round" strokeLinejoin="round" d="M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-1.5h5.25m-5.25 0h5.25m-5.25 0h5.25M9 9.75l3 3m0 0l3-3m-3 3v-6m-1.5 1.5H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />}
                {name === 'transactions' && <path strokeLinecap="round" strokeLinejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 8.25m0 0L16.5 12M21 8.25H7.5" />}
                {name === 'completed' && <path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />}
                {name === 'manage' && <path strokeLinecap="round" strokeLinejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-1.226M10.343 3.94a3.75 3.75 0 0 1-3.296 3.296M10.343 3.94A3.75 3.75 0 0 0 9 3.75h1.5M13.657 3.94c-.09.542-.56 1.007-1.11 1.226m1.11-1.226a3.75 3.75 0 0 1 3.296 3.296M13.657 3.94A3.75 3.75 0 0 0 15 3.75h-1.5m-3.75 16.5c.09.542.56 1.007 1.11 1.226M10.343 20.06a3.75 3.75 0 0 1-3.296-3.296M10.343 20.06a3.75 3.75 0 0 0-1.296-.286H7.5m2.843 3.526A3.75 3.75 0 0 0 12 21.75h-1.5m3.75-1.5c-.09-.542-.56-1.007-1.11-1.226m1.11-1.226a3.75 3.75 0 0 0 3.296-3.296M13.657 20.06a3.75 3.75 0 0 1 1.296-.286H16.5m-2.843 3.526A3.75 3.75 0 0 1 12 21.75h1.5M12 12a3.75 3.75 0 1 0 0-7.5 3.75 3.75 0 0 0 0 7.5Zm0 0v2.25M12 12h2.25M12 12l-2.25-2.25M12 12l2.25 2.25M12 12l-2.25 2.25M12 12l2.25-2.25" />}
                {name === 'export' && <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />}
                {name === 'import' && <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />}
                {name === 'delete' && <path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />}
                {name === 'menu' && <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />}
            </svg>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-50 transition-opacity" onClick={onClose}>
                    <div className="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg m-4 border border-gray-700" onClick={(e) => e.stopPropagation()}>
                        <div className="flex justify-between items-center p-4 border-b border-gray-700">
                            <h2 className="text-xl font-bold text-white">{title}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-3xl font-light">×</button>
                        </div>
                        <div className="p-6">{children}</div>
                    </div>
                </div>
            );
        };

        const StatCard = ({ title, value, icon }) => (
  <div className="bg-gray-900 rounded-lg p-4 flex flex-col items-start shadow border border-gray-800 min-w-[120px]">
    <div className="flex items-center gap-2 mb-2 text-brand-primary text-2xl">{icon}</div>
    <div className="text-lg font-bold text-white">{value}</div>
    <div className="text-xs text-gray-400 mt-1">{title}</div>
  </div>
);

const ProfitLossStatCard = ({ title, value, currency, subValue, subLabel }) => {
  const color = value > 0 ? 'text-green-400' : value < 0 ? 'text-red-400' : 'text-gray-200';
  return (
    <div className="bg-gray-900 rounded-lg p-4 flex flex-col items-start shadow border border-gray-800 min-w-[120px]">
      <div className="flex items-center gap-2 mb-2 text-xl">💹</div>
      <div className={`text-lg font-bold ${color}`}>{formatCurrency(value, currency)}</div>
      {subValue !== undefined && (
        <div className="text-xs mt-1"><span className="font-semibold">{subValue.toFixed(1)}%</span> <span className="text-gray-400">{subLabel}</span></div>
      )}
      <div className="text-xs text-gray-400 mt-1">{title}</div>
    </div>
  );
};

        const ManageView = ({ pokerSites, setPokerSites, gameTypes, setGameTypes, gameFormats, setGameFormats, gameStructures, setGameStructures, tournaments, transactions, showToast }) => {
            const [newItem, setNewItem] = useState({ type: 'pokerSites', name: '', currency: 'INR' });
            const importFileRef = useRef(null);

            // Helper for adding items
            const handleAddItem = (listType, setter) => {
                if (!newItem.name.trim()) return;
                if (listType === 'pokerSites') {
                    if (pokerSites.some(site => site.name.toLowerCase() === newItem.name.trim().toLowerCase())) {
                        showToast('Poker site already exists.', 'error');
                        return;
                    }
                    setter(prev => [...prev, { id: Date.now(), name: newItem.name.trim(), currency: newItem.currency }]);
                    showToast(`Poker site "${newItem.name}" added.`);
                } else {
                    // For gameTypes, gameFormats, gameStructures
                    const list = listType === 'gameTypes' ? gameTypes : listType === 'gameFormats' ? gameFormats : gameStructures;
                    if (list.some(item => item.toLowerCase() === newItem.name.trim().toLowerCase())) {
                        showToast('Entry already exists.', 'error');
                        return;
                    }
                    setter(prev => [...prev, newItem.name.trim()]);
                    showToast(`Added: ${newItem.name}`);
                }
                setNewItem({ type: listType, name: '', currency: 'INR' });
            };

            // Helper for deleting items
            const handleDeleteItem = (listType, setter, idOrName) => {
                if (listType === 'pokerSites') {
                    if (tournaments.some(t => t.pokerSite === pokerSites.find(s => s.id === idOrName)?.name) || transactions.some(tx => tx.pokerSite === pokerSites.find(s => s.id === idOrName)?.name)) {
                        showToast('Cannot delete: Site in use.', 'error');
                        return;
                    }
                    setter(prev => prev.filter(item => item.id !== idOrName));
                    showToast('Poker site deleted.');
                } else {
                    setter(prev => prev.filter(item => item !== idOrName));
                    showToast('Entry deleted.');
                }
            };

            // Backup/Restore
            const handleExport = () => {
                const dataToExport = {};
                APP_DATA_KEYS.forEach(key => { dataToExport[key] = JSON.parse(localStorage.getItem(key) || '[]'); });
                const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `poker-manager-backup-${getTodayDate()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Data exported successfully!');
            };
            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                if (!window.confirm("Are you sure you want to import data? This will overwrite all current application data.")) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        APP_DATA_KEYS.forEach(key => {
                            if (data[key]) localStorage.setItem(key, JSON.stringify(data[key]));
                        });
                        showToast('Data imported! Reloading...');
                        setTimeout(() => window.location.reload(), 1200);
                    } catch (error) {
                        showToast('Error importing file.', 'error');
                    }
                };
                reader.readAsText(file);
            };

            // Render compact list manager
            const renderListManager = (title, list, setter, listType = 'string') => (
                <div className="bg-gray-800 p-3 rounded-lg shadow-md flex flex-col gap-2">
                    <div className="flex gap-2 items-center mb-1">
                        <input
                            type="text"
                            className="input-field bg-gray-900 text-gray-100 placeholder-gray-400 border-gray-700"
                            placeholder={`Add ${title}`}
                            value={newItem.type === listType ? newItem.name : ''}
                            onChange={e => setNewItem({ ...newItem, type: listType, name: e.target.value })}
                            onKeyDown={e => { if (e.key === 'Enter') handleAddItem(listType, setter); }}
                        />
                        {listType === 'pokerSites' && (
                            <select className="input-field bg-gray-900 text-gray-100 border-gray-700 w-24" value={newItem.currency} onChange={e => setNewItem({ ...newItem, type: listType, currency: e.target.value })}>
                                <option value="INR">INR</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                            </select>
                        )}
                        <button className="btn-primary px-3 py-2" onClick={() => handleAddItem(listType, setter)}>Add</button>
                    </div>
                    <ul className="space-y-1 max-h-32 overflow-y-auto">
                        {listType === 'pokerSites'
                            ? list.map(site => (
                                <li key={site.id} className="flex justify-between items-center bg-gray-900 rounded px-2 py-1">
                                    <span>{site.name} <span className="text-xs text-gray-400">({site.currency})</span></span>
                                    <button className="btn-action-danger" onClick={() => handleDeleteItem(listType, setter, site.id)} title="Delete">✕</button>
                                </li>
                            ))
                            : list.map(item => (
                                <li key={item} className="flex justify-between items-center bg-gray-900 rounded px-2 py-1">
                                    <span>{item}</span>
                                    <button className="btn-action-danger" onClick={() => handleDeleteItem(listType, setter, item)} title="Delete">✕</button>
                                </li>
                            ))}
                    </ul>
                </div>
            );

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold tracking-tight">Manage Application Data</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {renderListManager('Poker Sites', pokerSites, setPokerSites, 'pokerSites')}
                        {renderListManager('Game Types', gameTypes, setGameTypes, 'gameTypes')}
                        {renderListManager('Game Formats', gameFormats, setGameFormats, 'gameFormats')}
                        {renderListManager('Game Structures', gameStructures, setGameStructures, 'gameStructures')}
                    </div>
                    <div className="bg-gray-800 p-4 rounded-lg shadow-md flex flex-col gap-2">
                        <div className="flex gap-2 items-center">
                            <button className="btn-primary" onClick={handleExport}><Icon name="export" className="w-5 h-5 inline" /> Backup Data</button>
                            <input type="file" ref={importFileRef} accept="application/json" className="hidden" onChange={handleImport} />
                            <button className="btn-secondary" onClick={() => importFileRef.current && importFileRef.current.click()}><Icon name="import" className="w-5 h-5 inline" /> Restore Data</button>
                        </div>
                        <p className="text-xs text-gray-400">Backup includes all tournaments, transactions, sites, and game configs. Restore will overwrite all data.</p>
                    </div>
                </div>
            );
        };

        const TransactionsView = ({ transactions, setTransactions, pokerSites, showToast }) => {
            const [tab, setTab] = useState('add');
            const [newTx, setNewTx] = useState({ date: getTodayDate(), pokerSite: pokerSites[0]?.name || '', deposit: '', withdrawal: '', tax: '', tournamentMoney: '', instantBonus: '', lockedBonus: '', other: '', notes: '' });
            const [sortConfig, setSortConfig] = useState({ key: 'date', direction: 'descending' });
            const [siteFilter, setSiteFilter] = useState('all');
            const [search, setSearch] = useState('');
            const [undoDelete, setUndoDelete] = useState(null);
            const tableRef = useRef(null);

            // --- Stat Cards ---
            const stats = useMemo(() => {
                const filtered = siteFilter === 'all' ? transactions : transactions.filter(tx => tx.pokerSite === siteFilter);
                let deposits = 0, withdrawals = 0, bonuses = 0, taxes = 0, tMoney = 0, other = 0, bankroll = 0;
                filtered.forEach(tx => {
                    deposits += tx.deposit || 0;
                    withdrawals += tx.withdrawal || 0;
                    bonuses += (tx.instantBonus || 0) + (tx.lockedBonus || 0);
                    taxes += tx.tax || 0;
                    tMoney += tx.tournamentMoney || 0;
                    other += tx.other || 0;
                });
                if (filtered.length > 0) bankroll = filtered[filtered.length - 1].newBankroll || 0;
                return { deposits, withdrawals, bonuses, taxes, tMoney, other, bankroll };
            }, [transactions, siteFilter]);

            // --- Filtering & Sorting ---
            const filteredTx = useMemo(() => {
                let items = [...transactions];
                if (siteFilter !== 'all') items = items.filter(tx => tx.pokerSite === siteFilter);
                if (search) {
                    const s = search.toLowerCase();
                    items = items.filter(tx =>
                        tx.pokerSite.toLowerCase().includes(s) ||
                        (tx.notes || '').toLowerCase().includes(s) ||
                        Object.values(tx).some(v => typeof v === 'number' && v.toString().includes(s))
                    );
                }
                if (sortConfig.key) {
                    items.sort((a, b) => {
                        const valA = a[sortConfig.key];
                        const valB = b[sortConfig.key];
                        if (valA < valB) return sortConfig.direction === 'ascending' ? -1 : 1;
                        if (valA > valB) return sortConfig.direction === 'ascending' ? 1 : -1;
                        return 0;
                    });
                }
                return items;
            }, [transactions, siteFilter, search, sortConfig]);

            // --- Handlers ---
            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setNewTx(prev => ({ ...prev, [name]: value }));
            };
            const handleAddTransaction = (e) => {
                e.preventDefault();
                if (!newTx.date || !newTx.pokerSite) { alert('Date and Poker Site are required.'); return; }
                const lastTxForSite = transactions.filter(tx => tx.pokerSite === newTx.pokerSite).sort((a, b) => b.id - a.id)[0];
                const lastBankroll = lastTxForSite ? lastTxForSite.newBankroll : 0;
                const deposit = parseFloat(newTx.deposit) || 0;
                const withdrawal = parseFloat(newTx.withdrawal) || 0;
                const tax = parseFloat(newTx.tax) || 0;
                const tournamentMoney = parseFloat(newTx.tournamentMoney) || 0;
                const instantBonus = parseFloat(newTx.instantBonus) || 0;
                const lockedBonus = parseFloat(newTx.lockedBonus) || 0;
                const other = parseFloat(newTx.other) || 0;
                const newBankroll = lastBankroll + deposit - withdrawal - tax + tournamentMoney + instantBonus + lockedBonus + other;
                const finalTx = { id: Date.now(), date: newTx.date, pokerSite: newTx.pokerSite, deposit, withdrawal, tax, tournamentMoney, instantBonus, lockedBonus, other, newBankroll, notes: newTx.notes };
                setTransactions(prev => [...prev, finalTx]);
                setNewTx({ date: getTodayDate(), pokerSite: newTx.pokerSite, deposit: '', withdrawal: '', tax: '', tournamentMoney: '', instantBonus: '', lockedBonus: '', other: '', notes: '' });
                showToast('Transaction added successfully.');
            };
            const handleDelete = (id) => {
                const tx = transactions.find(t => t.id === id);
                setTransactions(prev => prev.filter(t => t.id !== id));
                setUndoDelete({ tx, timeout: setTimeout(() => setUndoDelete(null), 4000) });
                showToast('Transaction deleted. Undo?', 'success');
            };
            const handleUndo = () => {
                if (undoDelete && undoDelete.tx) {
                    setTransactions(prev => [...prev, undoDelete.tx].sort((a, b) => a.id - b.id));
                    clearTimeout(undoDelete.timeout);
                    setUndoDelete(null);
                    showToast('Undo successful.');
                }
            };
            const requestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') direction = 'descending';
                setSortConfig({ key, direction });
            };
            const getSortIndicator = (key) => {
                if (sortConfig.key !== key) return '↕';
                return sortConfig.direction === 'ascending' ? '▲' : '▼';
            };
            const renderValue = (value) => {
                if (value === 0 || !value) return <span className="text-gray-500">-</span>;
                const color = value > 0 ? 'text-green-400' : 'text-red-400';
                return <span className={color}>{value.toFixed(2)}</span>;
            };
            const txFields = [
                { name: 'deposit', label: 'Deposit (+)', icon: '⬆️' },
                { name: 'withdrawal', label: 'Withdrawal (-)', icon: '⬇️' },
                { name: 'tax', label: 'Tax (-)', icon: '🧾' },
                { name: 'tournamentMoney', label: 'T-Money (+)', icon: '🎫' },
                { name: 'instantBonus', label: 'Instant Bonus (+)', icon: '⚡' },
                { name: 'lockedBonus', label: 'Locked Bonus (+)', icon: '🔒' },
                { name: 'other', label: 'Other (+/-)', icon: '🔄' }
            ];

            // --- UI ---
            return (
                <div className="space-y-8">
                    <h2 className="text-3xl font-bold tracking-tight">Transactions</h2>
                    {/* Tabs */}
                    <div className="flex gap-2 mb-4 border-b border-gray-700 sticky top-16 z-30 bg-gray-900/90 backdrop-blur px-2 rounded-t-lg">
                        <button onClick={() => setTab('add')} className={`px-4 py-2 font-semibold rounded-t ${tab === 'add' ? 'bg-brand-primary text-gray-900 shadow' : 'text-gray-300 hover:bg-gray-800'}`}>Add Transaction</button>
                        <button onClick={() => setTab('all')} className={`px-4 py-2 font-semibold rounded-t ${tab === 'all' ? 'bg-brand-primary text-gray-900 shadow' : 'text-gray-300 hover:bg-gray-800'}`}>All Transactions</button>
                    </div>
                    {/* Stat Cards & Filter Bar */}
                    <div className="flex flex-wrap gap-4 items-center justify-between sticky top-28 z-20 bg-gray-900/90 backdrop-blur px-2 py-2 rounded-lg border border-gray-800">
                        <div className="flex flex-wrap gap-2">
                            <div className="flex items-center gap-1"><span className="text-lg">⬆️</span> <span className="font-bold text-green-400">{formatCurrency(stats.deposits)}</span></div>
                            <div className="flex items-center gap-1"><span className="text-lg">⬇️</span> <span className="font-bold text-red-400">{formatCurrency(stats.withdrawals)}</span></div>
                            <div className="flex items-center gap-1"><span className="text-lg">⚡</span> <span className="font-bold text-green-300">{formatCurrency(stats.bonuses)}</span></div>
                            <div className="flex items-center gap-1"><span className="text-lg">🧾</span> <span className="font-bold text-red-300">{formatCurrency(stats.taxes)}</span></div>
                            <div className="flex items-center gap-1"><span className="text-lg">🎫</span> <span className="font-bold text-green-200">{formatCurrency(stats.tMoney)}</span></div>
                            <div className="flex items-center gap-1"><span className="text-lg">🔄</span> <span className="font-bold">{formatCurrency(stats.other)}</span></div>
                            <div className="flex items-center gap-1"><span className="text-lg">💰</span> <span className="font-bold text-brand-primary">{formatCurrency(stats.bankroll)}</span></div>
                        </div>
                        <div className="flex gap-2 items-center">
                            <select value={siteFilter} onChange={e => setSiteFilter(e.target.value)} className="input-field text-sm">
                                <option value="all">All Sites</option>
                                {pokerSites.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                            </select>
                            <input type="text" placeholder="Search..." value={search} onChange={e => setSearch(e.target.value)} className="input-field text-sm w-32" />
                        </div>
                    </div>
                    {/* Tab Content */}
                    {tab === 'add' && (
                        <form onSubmit={handleAddTransaction} className="bg-gray-800 p-6 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div className="flex flex-col gap-1">
                                <label className="label">Date *</label>
                                <input type="date" name="date" value={newTx.date} onChange={handleInputChange} className="input-field w-full" required/>
                            </div>
                            <div className="flex flex-col gap-1">
                                <label className="label">Poker Site *</label>
                                <select name="pokerSite" value={newTx.pokerSite} onChange={handleInputChange} className="input-field w-full" required>
                                    <option value="">Select Site</option>
                                    {pokerSites.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            </div>
                            {txFields.map(f => (
                                <div className="flex flex-col gap-1" key={f.name}>
                                    <label className="label flex items-center gap-1">{f.icon} {f.label}</label>
                                    <input type="number" step="0.01" name={f.name} placeholder="0" value={newTx[f.name]} onChange={handleInputChange} className="input-field w-full" />
                                </div>
                            ))}
                            <div className="flex flex-col gap-1 md:col-span-2 lg:col-span-3">
                                <label className="label">Notes</label>
                                <input type="text" name="notes" placeholder="Optional notes..." value={newTx.notes} onChange={handleInputChange} className="input-field w-full" />
                            </div>
                            <div className="flex justify-end md:col-span-2 lg:col-span-3 pt-2">
                                <button type="submit" className="btn-primary w-full sm:w-auto">Add Transaction</button>
                            </div>
                        </form>
                    )}
                    {tab === 'all' && (
                        <div className="bg-gray-800 rounded-lg shadow-md overflow-x-auto">
                            <table ref={tableRef} className="w-full text-sm text-left">
                                <thead className="bg-gray-700 text-xs uppercase tracking-wider sticky top-0 z-10">
                                    <tr>
                                        <th className="px-2 py-2 cursor-pointer" onClick={() => requestSort('date')}>Date {getSortIndicator('date')}</th>
                                        <th className="px-2 py-2 cursor-pointer" onClick={() => requestSort('pokerSite')}>Site {getSortIndicator('pokerSite')}</th>
                                        <th className="px-2 py-2 cursor-pointer" onClick={() => requestSort('gameType')}>Game {getSortIndicator('gameType')}</th>
                                        <th className="px-2 py-2 cursor-pointer" onClick={() => requestSort('format')}>Format {getSortIndicator('format')}</th>
                                        <th className="px-2 py-2 cursor-pointer" onClick={() => requestSort('structure')}>Structure {getSortIndicator('structure')}</th>
                                        <th className="px-2 py-2 cursor-pointer" onClick={() => requestSort('buyIn')}>Buy-in {getSortIndicator('buyIn')}</th>
                                        <th className="px-2 py-2 cursor-pointer" onClick={() => requestSort('fee')}>Fee {getSortIndicator('fee')}</th>
                                        <th className="px-2 py-2 cursor-pointer" onClick={() => requestSort('cash')}>Cash {getSortIndicator('cash')}</th>
                                        <th className="px-2 py-2 cursor-pointer" onClick={() => requestSort('finish')}>Finish {getSortIndicator('finish')}</th>
                                        <th className="px-2 py-2 cursor-pointer" onClick={() => requestSort('entries')}>Entries {getSortIndicator('entries')}</th>
                                        <th className="px-2 py-2">Notes</th>
                                        <th className="px-2 py-2">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-700">
                                    {filteredTx.length === 0 && (
                                        <tr><td colSpan={13} className="text-center text-gray-500 py-6">No tournaments found.</td></tr>
                                    )}
                                    {filteredTx.map((t, idx) => (
                                        <tr key={t.id} className={idx % 2 === 0 ? 'bg-gray-900/60' : 'bg-gray-800/60 hover:bg-gray-700/60'}>
                                            <td className="px-2 py-1 whitespace-nowrap">{t.date}</td>
                                            <td className="px-2 py-1 whitespace-nowrap">{t.pokerSite}</td>
                                            <td className="px-2 py-1 whitespace-nowrap">{t.gameType}</td>
                                            <td className="px-2 py-1 whitespace-nowrap">{t.format}</td>
                                            <td className="px-2 py-1 whitespace-nowrap">{t.structure}</td>
                                            <td className="px-2 py-1 text-right">{renderValue(t.buyIn, true)}</td>
                                            <td className="px-2 py-1 text-right">{renderValue(t.fee, true)}</td>
                                            <td className="px-2 py-1 text-right">{renderValue(t.cash, true)}</td>
                                            <td className="px-2 py-1 text-right">{renderValue(t.finish)}</td>
                                            <td className="px-2 py-1 text-right">{renderValue(t.entries)}</td>
                                            <td className="px-2 py-1 max-w-xs truncate" title={t.notes}>{t.notes}</td>
                                            <td className="px-2 py-1">
                                                <button onClick={() => handleDelete(t.id)} className="text-red-400 hover:text-red-600" title="Delete"><Icon name="delete" className="w-5 h-5" /></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                    {undoDelete && (
                        <div className="fixed bottom-6 right-6 z-50 bg-gray-900 text-white px-4 py-2 rounded shadow-lg flex items-center gap-4 border border-brand-primary">
                            <span>Tournament deleted.</span>
                            <button onClick={handleUndo} className="btn-primary py-1 px-3">Undo</button>
                        </div>
                    )}
                </div>
            );
        };

        const TournamentTable = ({ tournaments, setTournaments, isResultsView = false, showToast }) => {
            const [sortConfig, setSortConfig] = useState({ key: 'id', direction: 'descending' });
            const [selectedIds, setSelectedIds] = useState(new Set());
            const [modal, setModal] = useState({ isOpen: false, type: '', data: null });

            // Add renderValue for formatting
            const renderValue = (value, isMoney) => {
                if (value === 0 || value === '' || value === undefined || value === null) return <span className="text-gray-500">-</span>;
                if (isMoney) {
                    const color = value > 0 ? 'text-green-400' : value < 0 ? 'text-red-400' : '';
                    return <span className={color}>{formatCurrency(value)}</span>;
                }
                return <span>{value}</span>;
            };

            const processedTournaments = useMemo(() => {
                let items = isResultsView ? tournaments.filter(t => t.entries !== null) : tournaments;
                items = items.map(t => {
                    const netBuyIn = (t.buyIn - (t.buyInDiscount || 0)) + (t.addon || 0);
                    const totalCashout = (t.bountyCashout || 0) + (t.itmCashout || 0);
                    const profitLoss = totalCashout - netBuyIn;
                    const roi = netBuyIn > 0 ? (profitLoss / netBuyIn) * 100 : 0;
                    return { ...t, netBuyIn, totalCashout, profitLoss, roi };
                });
                if (sortConfig.key) {
                    items.sort((a, b) => {
                        const valA = a[sortConfig.key]; const valB = b[sortConfig.key];
                        if (valA < valB) return sortConfig.direction === 'ascending' ? -1 : 1;
                        if (valA > valB) return sortConfig.direction === 'ascending' ? 1 : -1;
                        return 0;
                    });
                }
                return items;
            }, [tournaments, sortConfig, isResultsView]);

            const handleSelectAll = (e) => {
                if (e.target.checked) setSelectedIds(new Set(processedTournaments.map(t => t.id)));
                else setSelectedIds(new Set());
            };

            const handleSelectOne = (id) => {
                setSelectedIds(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(id)) newSet.delete(id); else newSet.add(id);
                    return newSet;
                });
            };

            const handleDelete = (idsToDelete) => {
                if (!window.confirm(`Are you sure you want to delete ${idsToDelete.length} tournament(s)?`)) return;
                setTournaments(prev => prev.filter(t => !idsToDelete.includes(t.id)));
                showToast(`${idsToDelete.length} tournament(s) deleted.`);
                if (idsToDelete.length > 1) setSelectedIds(new Set());
            };

            const handleClearUncompleted = () => {
                if (!window.confirm('Are you sure you want to delete ALL uncompleted tournaments? This cannot be undone.')) return;
                setTournaments(prev => prev.filter(t => t.entries !== null));
                showToast('All uncompleted tournaments deleted.');
            };

            const openModal = (type, tournament = null) => {
                let initialData = { entries: '', addon: 0, bountyCashout: 0, itmCashout: 0, tournamentMoneyCashout: 0, finishPosition: '' };
                if (tournament && type === 'edit') {
                    Object.keys(initialData).forEach(key => { initialData[key] = tournament[key] || initialData[key]; });
                }
                setModal({ isOpen: true, type, data: tournament, formData: initialData });
            };

            const handleUpdateResult = (formData) => {
                setTournaments(prev => prev.map(t => {
                    if (t.id === modal.data.id) {
                        return { ...t,
                            entries: parseInt(formData.entries), addon: parseFloat(formData.addon) || 0,
                            bountyCashout: parseFloat(formData.bountyCashout) || 0, itmCashout: parseFloat(formData.itmCashout) || 0,
                            tournamentMoneyCashout: parseFloat(formData.tournamentMoneyCashout) || 0,
                            finishPosition: formData.finishPosition ? parseInt(formData.finishPosition) : null,
                        };
                    }
                    return t;
                }));
                setModal({ isOpen: false, type: '', data: null });
                showToast('Tournament result updated.');
            };

            const getTournamentStatus = (tournament) => {
                if (tournament.entries !== null) return { status: 'Completed', color: 'text-purple-400', extra: null };
                const now = new Date();
                const startTime = new Date(`${tournament.date}T${tournament.time}:00`);
                const diffMs = startTime - now;
                if (diffMs > 0) {
                    // Upcoming
                    const mins = Math.floor(diffMs / 60000);
                    const hours = Math.floor(mins / 60);
                    const minsLeft = mins % 60;
                    return {
                        status: mins <= 60 ? 'Starting Soon' : 'Upcoming',
                        color: mins <= 60 ? 'text-warning' : 'text-gray-400',
                        extra: `Time left: ${hours > 0 ? hours + 'h ' : ''}${minsLeft}m`
                    };
                } else {
                    // In progress
                    const elapsedMs = -diffMs;
                    const mins = Math.floor(elapsedMs / 60000);
                    const hours = Math.floor(mins / 60);
                    const minsRun = mins % 60;
                    return {
                        status: mins <= 60 ? 'Just Started' : 'In Progress',
                        color: mins <= 60 ? 'text-success' : 'text-blue-400',
                        extra: `Running: ${hours > 0 ? hours + 'h ' : ''}${minsRun}m`
                    };
                }
            };

            const requestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') direction = 'descending';
                setSortConfig({ key, direction });
            };
            const getSortIndicator = (key) => sortConfig.key === key ? (sortConfig.direction === 'ascending' ? '▲' : '▼') : '↕';

            const headers = [{ key: 'date', label: 'Date' }];
            if (!isResultsView) headers.push({ key: 'status', label: 'Status', sortable: false });
            headers.push(
                { key: 'name', label: 'Name' }, { key: 'pokerSite', label: 'Site' },
                { key: 'buyIn', label: 'Buy-in' }, { key: 'gtd', label: 'GTD' },
                { key: 'entries', label: 'Entries' }
            );
            if (isResultsView) {
                headers.push(
                    { key: 'finishPosition', label: 'Finish' }, { key: 'totalCashout', label: 'Cashout' },
                    { key: 'profitLoss', label: 'Profit/Loss' }, { key: 'roi', label: 'ROI (%)' }
                );
            }
            headers.push({ key: 'actions', label: 'Actions', sortable: false });

            const pokerSites = JSON.parse(localStorage.getItem('poker_sites') || '[]');

            return (
                <div>
                    {!isResultsView && (
                        <div className="mb-4 flex flex-wrap gap-2 items-center">
                            <button onClick={() => handleDelete(Array.from(selectedIds))} disabled={selectedIds.size === 0} className="btn-danger inline-flex items-center gap-2">
                                <Icon name="delete" className="w-4 h-4" /> Delete Selected
                            </button>
                            <button onClick={handleClearUncompleted} className="btn-secondary">Clear Uncompleted MTTs</button>
                        </div>
                    )}
                    <div className="overflow-x-auto bg-gray-800 rounded-lg shadow-md">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-700 text-xs uppercase tracking-wider">
                                <tr>
                                    <th scope="col" className="p-2 text-center"><input type="checkbox" onChange={handleSelectAll} checked={selectedIds.size > 0 && selectedIds.size === processedTournaments.length} className="checkbox"/></th>
                                    {headers.map(h => (
                                        <th key={h.key} scope="col" className="p-3" onClick={() => h.sortable !== false && requestSort(h.key)}>
                                            <span className={h.sortable !== false ? 'cursor-pointer hover:text-white' : ''}>
                                                {h.label} {h.sortable !== false && <span className="text-gray-400">{getSortIndicator(h.key)}</span>}
                                            </span>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-700">
                                {processedTournaments.map((t, index) => {
                                    const site = pokerSites.find(s => s.name === t.pokerSite) || { currency: '' };
                                    const isCompleted = t.entries !== null;
                                    let rowBgClass = index % 2 === 0 ? 'bg-gray-800' : 'bg-gray-750';
                                    let profitColor = t.profitLoss > 0 ? 'text-success' : t.profitLoss < 0 ? 'text-danger' : '';

                                    return (
                                        <tr key={t.id} className={`${rowBgClass} hover:bg-gray-700/70`}>
                                            <td className="p-2 text-center"><input type="checkbox" checked={selectedIds.has(t.id)} onChange={() => handleSelectOne(t.id)} className="checkbox"/></td>
                                            <td className="p-3 whitespace-nowrap">{t.date}</td>
                                            <td className="p-3">{t.pokerSite}</td>
                                            <td className="p-3">{t.gameType}</td>
                                            <td className="p-3">{t.format}</td>
                                            <td className="p-3">{t.structure}</td>
                                            <td className="p-3 text-right">{renderValue(t.buyIn, true)}</td>
                                            <td className="p-3 text-right">{renderValue(t.fee, true)}</td>
                                            <td className="p-3 text-right">{renderValue(t.cash, true)}</td>
                                            <td className="p-3 text-right">{renderValue(t.finish)}</td>
                                            <td className="p-3 text-right">{renderValue(t.entries)}</td>
                                            <td className="p-3 max-w-xs truncate" title={t.notes}>{t.notes}</td>
                                            <td className="p-3 flex gap-2">
                                                {!isCompleted ? (
                                                    <button onClick={() => openModal('update', t)} className="btn-action-primary">Update</button>
                                                ) : (
                                                    <div className="flex gap-2">
                                                        <button onClick={() => openModal('edit', t)} className="btn-action-secondary">Edit</button>
                                                        <button onClick={() => openModal('view', t)} className="btn-action-secondary">View</button>
                                                    </div>
                                                )}
                                                <button onClick={() => handleDelete([t.id])} className="btn-action-danger">Del</button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    {modal.isOpen && modal.type === 'view' && (
                        <Modal isOpen={modal.isOpen} onClose={() => setModal({isOpen: false})} title={`View: ${modal.data.name}`}>
                            <div className="space-y-2 text-gray-300">
                                {Object.entries(modal.data).map(([key, value]) => (
                                    <div key={key} className="grid grid-cols-2">
                                        <strong className="capitalize text-gray-100">{key.replace(/([A-Z])/g, ' $1')}:</strong>
                                        <span>{value === null ? 'N/A' : String(value)}</span>
                                    </div>
                                ))}
                            </div>
                        </Modal>
                    )}
                    {modal.isOpen && (modal.type === 'update' || modal.type === 'edit') && (
                        <UpdateResultModal modal={modal} setModal={setModal} onSave={handleUpdateResult} />
                    )}
                </div>
            );
        };

        const UpdateResultModal = ({ modal, setModal, onSave }) => {
            const [formData, setFormData] = useState(modal.formData);
            const handleChange = e => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            const handleSubmit = e => {
                e.preventDefault();
                if (!formData.entries) { alert('Entries field is mandatory to complete a tournament.'); return; }
                onSave(formData);
            };
            const fields = [
                { name: 'entries', label: 'Total Entries', type: 'number', required: true },
                { name: 'finishPosition', label: 'Finish Position', type: 'number' },
                { name: 'itmCashout', label: 'ITM Cashout', type: 'number' },
                { name: 'bountyCashout', label: 'Bounty Cashout', type: 'number' },
                { name: 'addon', label: 'Add-on / Re-entry Cost', type: 'number' },
                { name: 'tournamentMoneyCashout', label: 'Tournament Money Won', type: 'number' },
            ];
            return (
                <Modal isOpen={modal.isOpen} onClose={() => setModal({isOpen: false})} title={`${modal.type === 'update' ? 'Update' : 'Edit'} Result for: ${modal.data.name}`}>
                    <div className="space-y-4">
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            {fields.map(f => (
                                <div key={f.name}>
                                    <label className="label">{f.label}{f.required && ' *'}</label>
                                    <input type={f.type} name={f.name} value={formData[f.name]} onChange={handleChange} className="input-field" placeholder="0" required={f.required} step="0.01"/>
                                </div>
                            ))}
                        </div>
                        <div className="flex justify-end gap-2 pt-4">
                            <button type="button" onClick={() => setModal({isOpen: false})} className="btn-secondary">Cancel</button>
                            <button onClick={handleSubmit} className="btn-primary">Save Result</button>
                        </div>
                    </div>
                </Modal>
            );
        };

        const DashboardView = ({ tournaments, transactions, pokerSites }) => {
            const [expandedCards, setExpandedCards] = useState({});
            const toggleCard = (siteName) => setExpandedCards(prev => ({ ...prev, [siteName]: !prev[siteName] }));

            const dashboardData = useMemo(() => {
                const completedTournaments = tournaments.filter(t => t.entries !== null);
                let overall = { totalBankroll: 0, totalProfitLoss: 0, totalNetBuyIns: 0, avgBuyIn: 0, completedCount: completedTournaments.length, roi: 0 };
                const perSite = pokerSites.map(site => {
                    const lastTx = transactions.filter(t => t.pokerSite === site.name).sort((a, b) => b.id - a.id)[0];
                    const bankroll = lastTx ? lastTx.newBankroll : 0;
                    const txOverview = transactions.filter(t => t.pokerSite === site.name).reduce((acc, tx) => {
                        acc.deposits += tx.deposit || 0; acc.withdrawals += tx.withdrawal || 0;
                        acc.taxes += tx.tax || 0; acc.bonuses += (tx.instantBonus || 0) + (tx.lockedBonus || 0) + (tx.tournamentMoney || 0);
                        acc.other += tx.other || 0; return acc;
                    }, { deposits: 0, withdrawals: 0, taxes: 0, bonuses: 0, other: 0 });

                    const siteMtts = completedTournaments.filter(t => t.pokerSite === site.name);
                    let totalNetBuyIns = 0; let totalCashouts = 0;
                    siteMtts.forEach(t => {
                        totalNetBuyIns += (t.buyIn - (t.buyInDiscount || 0)) + (t.addon || 0);
                        totalCashouts += (t.bountyCashout || 0) + (t.itmCashout || 0);
                    });
                    const profitLoss = totalCashouts - totalNetBuyIns;
                    const roi = totalNetBuyIns > 0 ? (profitLoss / totalNetBuyIns) * 100 : 0;
                    const avgBuyIn = siteMtts.length > 0 ? totalNetBuyIns / siteMtts.length : 0;
                    const rate = EXCHANGE_RATES[site.currency] || 1;
                    overall.totalBankroll += bankroll * rate;
                    overall.totalNetBuyIns += totalNetBuyIns * rate;
                    overall.totalProfitLoss += profitLoss * rate;
                    return { ...site, bankroll, profitLoss, roi, avgBuyIn, completedCount: siteMtts.length, txOverview };
                });
                overall.roi = overall.totalNetBuyIns > 0 ? (overall.totalProfitLoss / overall.totalNetBuyIns) * 100 : 0;
                overall.avgBuyIn = overall.completedCount > 0 ? overall.totalNetBuyIns / overall.completedCount : 0;
                return { overall, perSite };
            }, [tournaments, transactions, pokerSites]);

            return (
                <div className="space-y-10">
                    <div>
                        <h2 className="text-3xl font-extrabold tracking-tight mb-6 text-brand-primary drop-shadow">Overall Performance (in INR)</h2>
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                            <StatCard title="Total Bankroll" value={formatCurrency(dashboardData.overall.totalBankroll, 'INR')} icon={<Icon name="dashboard" className="w-7 h-7 text-brand-primary" />} />
                            <ProfitLossStatCard title="Total Profit/Loss" value={dashboardData.overall.totalProfitLoss} currency="INR" subValue={dashboardData.overall.roi} subLabel="% ROI" />
                            <StatCard title="Avg. Buy-In" value={formatCurrency(dashboardData.overall.avgBuyIn, 'INR')} icon={<span>₹</span>} />
                            <StatCard title="Completed MTTs" value={dashboardData.overall.completedCount} icon={<span>🎯</span>} />
                        </div>
                    </div>
                    <div>
                        <h2 className="text-2xl font-bold mb-4 text-brand-primary">Per-Site Performance</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            {dashboardData.perSite.map(site => (
                                <div key={site.id} className="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-6 space-y-4 shadow-2xl border border-gray-700 hover:scale-[1.02] transition-transform">
                                    <h3 className="text-xl font-bold text-brand-primary flex items-center gap-2">{site.name} <span className="text-xs text-gray-400">({site.currency})</span></h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        <StatCard title="Bankroll" value={formatCurrency(site.bankroll, site.currency)} icon={<span>💰</span>} />
                                        <StatCard title="Avg. Buy-In" value={formatCurrency(site.avgBuyIn, site.currency)} icon={<span>₹</span>} />
                                        <ProfitLossStatCard title="P/L (MTTs)" value={site.profitLoss} currency={site.currency} subValue={site.roi} subLabel="% ROI" />
                                        <StatCard title="MTTs Played" value={site.completedCount} icon={<span>🎲</span>} />
                                    </div>
                                    <div className="pt-2">
                                        <button onClick={() => toggleCard(site.name)} className="w-full text-left text-sm font-semibold text-brand-primary hover:text-white flex justify-between items-center">
                                            <span>Total Transactions Overview</span>
                                            <span className="transform transition-transform">{expandedCards[site.name] ? '−' : '+'}</span>
                                        </button>
                                        <div className={`collapsible-content ${expandedCards[site.name] ? 'expanded' : ''} pt-2`}>
                                            <div className="text-xs space-y-1 text-gray-300 bg-gray-900 p-3 rounded-lg border border-gray-700">
                                                <p className="flex justify-between"><span>Deposits:</span> <span className="text-success">{formatCurrency(site.txOverview.deposits, site.currency)}</span></p>
                                                <p className="flex justify-between"><span>Withdrawals:</span> <span className="text-danger">{formatCurrency(site.txOverview.withdrawals, site.currency)}</span></p>
                                                <p className="flex justify-between"><span>Taxes:</span> <span className="text-danger">{formatCurrency(site.txOverview.taxes, site.currency)}</span></p>
                                                <p className="flex justify-between"><span>Bonuses/T-Money:</span> <span className="text-success">{formatCurrency(site.txOverview.bonuses, site.currency)}</span></p>
                                                <p className="flex justify-between"><span>Other:</span> <span>{formatCurrency(site.txOverview.other, site.currency)}</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const CompletedTournamentsView = ({ tournaments, setTournaments, showToast }) => {
            // Only show tournaments with entries (completed)
            const completed = tournaments.filter(t => t.entries !== null && t.entries !== undefined && t.entries !== '');
            return (
                <div className="space-y-8">
                    <h2 className="text-3xl font-bold tracking-tight">Results</h2>
                    <TournamentTable tournaments={completed} setTournaments={setTournaments} isResultsView={true} showToast={showToast} />
                </div>
            );
        };

        const TournamentsView = ({ tournaments, setTournaments, pokerSites, gameTypes, gameFormats, gameStructures, showToast }) => {
            const [tab, setTab] = useState('add');
            const [newT, setNewT] = useState({
                date: getTodayDate(),
                name: '',
                pokerSite: pokerSites[0]?.name || '',
                gameType: gameTypes[0] || '',
                format: gameFormats[0] || '',
                structure: gameStructures[0] || '',
                buyIn: '',
                gtd: '',
                entries: '',
                notes: ''
            });
            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setNewT(prev => ({ ...prev, [name]: value }));
            };
            const handleAddTournament = (e) => {
                e.preventDefault();
                if (!newT.date || !newT.name || !newT.pokerSite) {
                    alert('Date, Name, and Poker Site are required.');
                    return;
                }
                setTournaments(prev => [
                    ...prev,
                    {
                        id: Date.now(),
                        ...newT,
                        buyIn: parseFloat(newT.buyIn) || 0,
                        gtd: parseFloat(newT.gtd) || 0,
                        entries: newT.entries ? parseInt(newT.entries) : null
                    }
                ]);
                setNewT({
                    date: getTodayDate(),
                    name: '',
                    pokerSite: pokerSites[0]?.name || '',
                    gameType: gameTypes[0] || '',
                    format: gameFormats[0] || '',
                    structure: gameStructures[0] || '',
                    buyIn: '',
                    gtd: '',
                    entries: '',
                    notes: ''
                });
                showToast('Tournament added successfully.');
            };
            return (
                <div className="space-y-8">
                    <h2 className="text-3xl font-bold tracking-tight">Tournaments</h2>
                    <div className="flex gap-2 mb-4 border-b border-gray-700 sticky top-16 z-30 bg-gray-900/90 backdrop-blur px-2 rounded-t-lg">
                        <button onClick={() => setTab('add')} className={`px-4 py-2 font-semibold rounded-t ${tab === 'add' ? 'bg-brand-primary text-gray-900 shadow' : 'text-gray-300 hover:bg-gray-800'}`}>Add Tournament</button>
                        <button onClick={() => setTab('all')} className={`px-4 py-2 font-semibold rounded-t ${tab === 'all' ? 'bg-brand-primary text-gray-900 shadow' : 'text-gray-300 hover:bg-gray-800'}`}>All Tournaments</button>
                    </div>
                    {tab === 'add' && (
                        <form onSubmit={handleAddTournament} className="bg-gray-800 p-6 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div className="flex flex-col gap-1">
                                <label className="label">Date *</label>
                                <input type="date" name="date" value={newT.date} onChange={handleInputChange} className="input-field w-full" required />
                            </div>
                            <div className="flex flex-col gap-1">
                                <label className="label">Name *</label>
                                <input type="text" name="name" value={newT.name} onChange={handleInputChange} className="input-field w-full" required />
                            </div>
                            <div className="flex flex-col gap-1">
                                <label className="label">Poker Site *</label>
                                <select name="pokerSite" value={newT.pokerSite} onChange={handleInputChange} className="input-field w-full" required>
                                    {pokerSites.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                </select>
                            </div>
                            <div className="flex flex-col gap-1">
                                <label className="label">Game Type</label>
                                <select name="gameType" value={newT.gameType} onChange={handleInputChange} className="input-field w-full">
                                    {gameTypes.map((g, i) => <option key={i} value={g}>{g}</option>)}
                                </select>
                            </div>
                            <div className="flex flex-col gap-1">
                                <label className="label">Format</label>
                                <select name="format" value={newT.format} onChange={handleInputChange} className="input-field w-full">
                                    {gameFormats.map((f, i) => <option key={i} value={f}>{f}</option>)}
                                </select>
                            </div>
                            <div className="flex flex-col gap-1">
                                <label className="label">Structure</label>
                                <select name="structure" value={newT.structure} onChange={handleInputChange} className="input-field w-full">
                                    {gameStructures.map((s, i) => <option key={i} value={s}>{s}</option>)}
                                </select>
                            </div>
                            <div className="flex flex-col gap-1">
                                <label className="label">Buy-in</label>
                                <input type="number" step="0.01" name="buyIn" value={newT.buyIn} onChange={handleInputChange} className="input-field w-full" />
                            </div>
                            <div className="flex flex-col gap-1">
                                <label className="label">GTD</label>
                                <input type="number" step="0.01" name="gtd" value={newT.gtd} onChange={handleInputChange} className="input-field w-full" />
                            </div>
                            <div className="flex flex-col gap-1">
                                <label className="label">Entries</label>
                                <input type="number" name="entries" value={newT.entries} onChange={handleInputChange} className="input-field w-full" />
                            </div>
                            <div className="flex flex-col gap-1 md:col-span-2 lg:col-span-3">
                                <label className="label">Notes</label>
                                <input type="text" name="notes" value={newT.notes} onChange={handleInputChange} className="input-field w-full" />
                            </div>
                            <div className="flex justify-end md:col-span-2 lg:col-span-3 pt-2">
                                <button type="submit" className="btn-primary w-full sm:w-auto">Add Tournament</button>
                            </div>
                        </form>
                    )}
                    {tab === 'all' && (
                        <TournamentTable tournaments={tournaments} setTournaments={setTournaments} showToast={showToast} />
                    )}
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [isNavOpen, setIsNavOpen] = useState(false);
            const [tournaments, setTournaments] = useLocalStorage('poker_tournaments', []);
            const [transactions, setTransactions] = useLocalStorage('poker_transactions', []);
            const [pokerSites, setPokerSites] = useLocalStorage('poker_sites', DEFAULT_POKER_SITES);
            const [gameTypes, setGameTypes] = useLocalStorage('poker_gameTypes', DEFAULT_GAME_TYPES);
            const [gameFormats, setGameFormats] = useLocalStorage('poker_gameFormats', DEFAULT_GAME_FORMATS);
            const [gameStructures, setGameStructures] = useLocalStorage('poker_gameStructures', DEFAULT_GAME_STRUCTURES);

            // THEME TOGGLE
            const [theme, setTheme] = useLocalStorage('pm_theme', 'dark');
            useEffect(() => {
                document.body.classList.toggle('bg-gray-950', theme === 'dark');
                document.body.classList.toggle('bg-white', theme === 'light');
                document.body.classList.toggle('text-gray-200', theme === 'dark');
                document.body.classList.toggle('text-gray-900', theme === 'light');
            }, [theme]);
            const toggleTheme = () => setTheme(theme === 'dark' ? 'light' : 'dark');

            // TOAST FEEDBACK
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
            const showToast = (message, type = 'success') => {
                setToast({ show: true, message, type });
                setTimeout(() => setToast({ show: false, message: '', type: 'success' }), 2500);
            };

            // ONBOARDING MODAL
            const [showOnboarding, setShowOnboarding] = useState(() => !localStorage.getItem('pm_onboarded'));
            const completeOnboarding = () => {
                setShowOnboarding(false);
                localStorage.setItem('pm_onboarded', '1');
            };

            const allSetters = { setTournaments, setTransactions, setPokerSites, setGameTypes, setGameFormats, setGameStructures };
            const commonProps = { tournaments, transactions, pokerSites, gameTypes, gameFormats, gameStructures, ...allSetters };

            const renderView = () => {
                switch (view) {
                    case 'tournaments': return <TournamentsView {...commonProps} showToast={showToast} />;
                    case 'transactions': return <TransactionsView {...commonProps} showToast={showToast} />;
                    case 'completed_tournaments': return <CompletedTournamentsView {...commonProps} showToast={showToast} />;
                    case 'manage': return <ManageView {...commonProps} showToast={showToast} />;
                    case 'dashboard': default: return <DashboardView {...commonProps} showToast={showToast} />;
                }
            };

            const NavItem = ({ viewName, currentView, setView, children, iconName }) => {
                const isActive = viewName === currentView;
                const classes = `flex items-center justify-start gap-x-2 px-3 py-2 text-sm font-medium rounded-md transition-colors w-full ${
                    isActive ? 'bg-brand-primary text-white shadow-lg' : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                }`;
                return (
                    <button onClick={() => { setView(viewName); setIsNavOpen(false); }} className={classes}>
                        <Icon name={iconName} className="w-5 h-5" />
                        <span>{children}</span>
                    </button>
                );
            };

            return (
                <div className={`min-h-screen ${theme === 'dark' ? 'bg-gray-950 text-gray-200' : 'bg-white text-gray-900'}`}>
                    {showOnboarding && (
                        <Modal isOpen={showOnboarding} onClose={completeOnboarding} title="Welcome to Poker Manager Pro!">
                            <div className="space-y-3">
                                <p>Welcome! This app helps you manage poker tournaments, track transactions, and analyze your performance. All data is stored locally in your browser.</p>
                                <ul className="list-disc pl-5 text-sm text-gray-400">
                                    <li>Use the navigation bar to switch between Dashboard, Tournaments, Transactions, Results, and Manage.</li>
                                    <li>Backup your data regularly from the Manage tab.</li>
                                    <li>Switch between dark and light mode using the theme toggle.</li>
                                </ul>
                                <button className="btn-primary mt-2" onClick={completeOnboarding}>Get Started</button>
                            </div>
                        </Modal>
                    )}
                    {toast.show && (
                        <div className={`fixed top-4 right-4 z-50 px-4 py-2 rounded shadow-lg ${toast.type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>{toast.message}</div>
                    )}
                    <nav className="bg-gray-900 shadow-md sticky top-0 z-40 border-b border-gray-700">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex items-center justify-between h-16">
                                <div className="flex items-center">
                                    <span className="text-white font-bold text-xl tracking-wider">Poker Pro</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={toggleTheme} className="text-gray-300 hover:text-white p-2" title="Toggle theme">
                                        {theme === 'dark' ? <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0  24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m8.66-13.66l-.71.71M4.05 19.07l-.71.71M21 12h-1M4  12H3m16.95 7.07l-.71-.71M4.05 4.93l-.71-.71" /></svg> : <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m8.66-13.66l-.71.71M4.05 19.07l-.71.71M21 12h-1M4 12H3m16.95 7.07l-.71-.71M4.05 4.93l-.71-.71" /></svg>}
                                    </button>
                                    <div className="hidden sm:flex items-baseline space-x-2">
                                        <NavItem viewName="dashboard" currentView={view} setView={setView} iconName="dashboard">Dashboard</NavItem>
                                        <NavItem viewName="tournaments" currentView={view} setView={setView} iconName="tournaments">Tournaments</NavItem>
                                        <NavItem viewName="transactions" currentView={view} setView={setView} iconName="transactions">Transactions</NavItem>
                                        <NavItem viewName="completed_tournaments" currentView={view} setView={setView} iconName="completed">Results</NavItem>
                                        <NavItem viewName="manage" currentView={view} setView={setView} iconName="manage">Manage</NavItem>
                                    </div>
                                    <div className="sm:hidden">
                                        <button onClick={() => setIsNavOpen(!isNavOpen)} className="text-gray-300 hover:text-white p-2">
                                            <Icon name="menu" className="w-6 h-6" />
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {isNavOpen && (
                                <div className="sm:hidden pb-4">
                                    <div className="flex flex-col space-y-2">
                                        <NavItem viewName="dashboard" currentView={view} setView={setView} iconName="dashboard">Dashboard</NavItem>
                                        <NavItem viewName="tournaments" currentView={view} setView={setView} iconName="tournaments">Tournaments</NavItem>
                                        <NavItem viewName="transactions" currentView={view} setView={setView} iconName="transactions">Transactions</NavItem>
                                        <NavItem viewName="completed_tournaments" currentView={view} setView={setView} iconName="completed">Results</NavItem>
                                        <NavItem viewName="manage" currentView={view} setView={setView} iconName="manage">Manage</NavItem>
                                    </div>
                                </div>
                            )}
                        </div>
                    </nav>
                    <main>
                        <div className="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                            {renderView()}
                        </div>
                    </main>
                    <style>{`
                        .input-field {
  background-color: #18181b !important;
  color: #e5e7eb !important;
  border: 1px solid #444 !important;
  border-radius: 4px;
  padding: 8px 10px;
  font-size: 1rem;
}
.input-field:focus {
  outline: 2px solid #6366f1;
  border-color: #6366f1;
}
::placeholder {
  color: #a1a1aa !important;
  opacity: 1;
}
.text-brand-primary { color: #ffd700; }
.bg-brand-primary { background-color: #ffd700; }
                    `}</style>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
