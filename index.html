<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18.3.1/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.24.7/babel.min.js"></script>

    <style>
        /* Simple transition for collapsible sections */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-content.expanded {
            max-height: 500px; /* Adjust as needed */
            transition: max-height 0.5s ease-in;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        //============== UTILITY & HELPER FUNCTIONS ==============//

        const { useState, useEffect, useMemo, useCallback } = React;

        // --- Hardcoded Exchange Rates ---
        const EXCHANGE_RATES = {
            'INR': 1,
            'USD': 83.50,
            'EUR': 90.10,
        };

        // --- Utility Functions ---
        const formatCurrency = (amount, currency = 'INR') => {
            try {
                return new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: currency,
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(amount);
            } catch (e) {
                return `${currency} ${amount.toFixed(2)}`;
            }
        };

        const getTodayDate = () => new Date().toISOString().split('T')[0];
        const getNowTime = () => new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

        //============== CUSTOM HOOKS ==============//

        function useLocalStorage(key, initialValue) {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.error(error);
                    return initialValue;
                }
            });

            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) {
                    console.error(error);
                }
            };

            return [storedValue, setValue];
        }

        //============== CORE DATA MODELS & DEFAULTS ==============//

        const DEFAULT_POKER_SITES = [
            { id: 1, name: 'PokerBaazi', currency: 'INR' },
            { id: 2, name: 'GGPoker', currency: 'USD' },
        ];
        const DEFAULT_GAME_TYPES = ['NLH', 'PLO', 'PLO5', 'PLO6'];
        const DEFAULT_GAME_FORMATS = ['Regular', 'PKO', 'Bounty', 'Deepstack', 'Turbo', 'Hyper-Turbo'];
        const DEFAULT_GAME_STRUCTURES = ['Regular', 'Turbo', 'Hyper-Turbo'];

        //============== APP COMPONENTS ==============//

        // --- MODAL COMPONENT ---
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
                    <div className="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 m-4" onClick={(e) => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-white">{title}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">Ã—</button>
                        </div>
                        <div>{children}</div>
                    </div>
                </div>
            );
        };

        // --- MANAGE VIEW ---
        const ManageView = ({
            pokerSites, setPokerSites,
            gameTypes, setGameTypes,
            gameFormats, setGameFormats,
            gameStructures, setGameStructures,
            tournaments, transactions
        }) => {
            const [newItem, setNewItem] = useState({ type: '', name: '', currency: 'INR' });

            const handleAddItem = (listType, setter) => {
                if (!newItem.name.trim()) return;
                if (listType === 'pokerSites') {
                    if (pokerSites.some(site => site.name.toLowerCase() === newItem.name.toLowerCase())) {
                        alert('A poker site with this name already exists.');
                        return;
                    }
                    setter(prev => [...prev, { id: Date.now(), name: newItem.name.trim(), currency: newItem.currency }]);
                } else {
                    setter(prev => [...prev, newItem.name.trim()]);
                }
                setNewItem({ type: '', name: '', currency: 'INR' });
            };

            const handleDeleteItem = (listType, setter, idOrName) => {
                if (listType === 'pokerSites') {
                    const siteName = pokerSites.find(s => s.id === idOrName)?.name;
                    const isUsed = tournaments.some(t => t.pokerSite === siteName) || transactions.some(t => t.pokerSite === siteName);
                    if (isUsed) {
                        alert('Cannot delete this site. It is currently used in tournaments or transactions.');
                        return;
                    }
                    setter(prev => prev.filter(item => item.id !== idOrName));
                } else {
                    setter(prev => prev.filter(item => item !== idOrName));
                }
            };

            const renderListManager = (title, list, setter, listType = 'string') => (
                <div className="bg-gray-800 p-4 rounded-lg">
                    <h3 className="text-lg font-semibold mb-3">{title}</h3>
                    {listType === 'pokerSites' ? (
                        <div className="flex flex-wrap gap-2 mb-2">
                            <input
                                type="text"
                                placeholder="Site Name"
                                value={newItem.type === 'pokerSites' ? newItem.name : ''}
                                onChange={(e) => setNewItem({ ...newItem, type: 'pokerSites', name: e.target.value })}
                                className="input-field flex-grow placeholder-gray-400"
                            />
                            <select
                                value={newItem.type === 'pokerSites' ? newItem.currency : 'INR'}
                                onChange={(e) => setNewItem({ ...newItem, currency: e.target.value })}
                                className="input-field"
                            >
                                {Object.keys(EXCHANGE_RATES).map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                            <button onClick={() => handleAddItem('pokerSites', setter)} className="btn-primary">Add</button>
                        </div>
                    ) : (
                        <div className="flex flex-wrap gap-2 mb-2">
                            <input
                                type="text"
                                placeholder={`New ${title.slice(7)}`}
                                value={newItem.type === title ? newItem.name : ''}
                                onChange={(e) => setNewItem({ ...newItem, type: title, name: e.target.value })}
                                className="input-field flex-grow placeholder-gray-400"
                            />
                            <button onClick={() => handleAddItem(title, setter)} className="btn-primary">Add</button>
                        </div>
                    )}
                    <ul className="space-y-1">
                        {list.map((item, index) => (
                            <li key={listType === 'pokerSites' ? item.id : index} className="flex justify-between items-center bg-gray-700 p-2 rounded">
                                <span>{listType === 'pokerSites' ? `${item.name} (${item.currency})` : item}</span>
                                <button onClick={() => handleDeleteItem(listType, setter, listType === 'pokerSites' ? item.id : item)} className="text-red-500 hover:text-red-400 text-xs">Delete</button>
                            </li>
                        ))}
                    </ul>
                </div>
            );

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold">Manage Application Data</h2>
                    <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                        {renderListManager('Manage Poker Sites', pokerSites, setPokerSites, 'pokerSites')}
                        {renderListManager('Manage Game Types', gameTypes, setGameTypes)}
                        {renderListManager('Manage Game Formats', gameFormats, setGameFormats)}
                        {renderListManager('Manage Game Structures', gameStructures, setGameStructures)}
                    </div>
                </div>
            );
        };

        // --- TRANSACTIONS VIEW ---
        const TransactionsView = ({ transactions, setTransactions, pokerSites }) => {
            const [newTx, setNewTx] = useState({
                date: getTodayDate(),
                pokerSite: pokerSites[0]?.name || '',
                deposit: '', withdrawal: '', tax: '', tournamentMoney: '', instantBonus: '', lockedBonus: '', other: ''
            });
            const [sortConfig, setSortConfig] = useState({ key: 'date', direction: 'descending' });

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setNewTx(prev => ({ ...prev, [name]: value }));
            };

            const handleAddTransaction = (e) => {
                e.preventDefault();
                if (!newTx.pokerSite) {
                    alert('Please select a poker site.');
                    return;
                }

                const lastTxForSite = transactions
                    .filter(tx => tx.pokerSite === newTx.pokerSite)
                    .sort((a, b) => b.id - a.id)[0];
                
                const lastBankroll = lastTxForSite ? lastTxForSite.newBankroll : 0;
                
                const deposit = parseFloat(newTx.deposit) || 0;
                const withdrawal = parseFloat(newTx.withdrawal) || 0;
                const tax = parseFloat(newTx.tax) || 0;
                const tournamentMoney = parseFloat(newTx.tournamentMoney) || 0;
                const instantBonus = parseFloat(newTx.instantBonus) || 0;
                const lockedBonus = parseFloat(newTx.lockedBonus) || 0;
                const other = parseFloat(newTx.other) || 0;

                const newBankroll = lastBankroll + deposit - withdrawal - tax + tournamentMoney + instantBonus + lockedBonus + other;

                const finalTx = {
                    id: Date.now(),
                    date: newTx.date,
                    pokerSite: newTx.pokerSite,
                    deposit, withdrawal, tax, tournamentMoney, instantBonus, lockedBonus, other,
                    newBankroll
                };

                setTransactions(prev => [...prev, finalTx]);
                setNewTx({
                    date: getTodayDate(),
                    pokerSite: newTx.pokerSite,
                    deposit: '', withdrawal: '', tax: '', tournamentMoney: '', instantBonus: '', lockedBonus: '', other: ''
                });
            };

            const sortedTransactions = useMemo(() => {
                let sortableItems = [...transactions];
                if (sortConfig.key) {
                    sortableItems.sort((a, b) => {
                        if (a[sortConfig.key] < b[sortConfig.key]) {
                            return sortConfig.direction === 'ascending' ? -1 : 1;
                        }
                        if (a[sortConfig.key] > b[sortConfig.key]) {
                            return sortConfig.direction === 'ascending' ? 1 : -1;
                        }
                        return 0;
                    });
                }
                return sortableItems;
            }, [transactions, sortConfig]);

            const requestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                    direction = 'descending';
                }
                setSortConfig({ key, direction });
            };

            const getSortIndicator = (key) => {
                if (sortConfig.key !== key) return 'â†•';
                return sortConfig.direction === 'ascending' ? 'â–²' : 'â–¼';
            };

            const renderValue = (value) => {
                if (value === 0 || !value) return <span className="text-gray-500">-</span>;
                const color = value > 0 ? 'text-green-400' : 'text-red-400';
                return <span className={color}>{value.toFixed(2)}</span>;
            };

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold">Add New Transaction</h2>
                    <form onSubmit={handleAddTransaction} className="bg-gray-800 p-4 rounded-lg grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        <div className="col-span-1">
                            <label className="label">Date</label>
                            <input type="date" name="date" value={newTx.date} onChange={handleInputChange} className="input-field" required/>
                        </div>
                        <div className="col-span-1">
                            <label className="label">Poker Site</label>
                            <select name="pokerSite" value={newTx.pokerSite} onChange={handleInputChange} className="input-field" required>
                                <option value="">Select Site</option>
                                {pokerSites.map(site => <option key={site.id} value={site.name}>{site.name}</option>)}
                            </select>
                        </div>
                        <div className="col-span-1">
                            <label className="label">Deposit (+)</label>
                            <input type="number" name="deposit" placeholder="0.00" value={newTx.deposit} onChange={handleInputChange} className="input-field" />
                        </div>
                        <div className="col-span-1">
                            <label className="label">Withdrawal (-)</label>
                            <input type="number" name="withdrawal" placeholder="0.00" value={newTx.withdrawal} onChange={handleInputChange} className="input-field" />
                        </div>
                        <div className="col-span-1">
                            <label className="label">Tax (-)</label>
                            <input type="number" name="tax" placeholder="0.00" value={newTx.tax} onChange={handleInputChange} className="input-field" />
                        </div>
                        <div className="col-span-1">
                            <label className="label">T-Money (+)</label>
                            <input type="number" name="tournamentMoney" placeholder="0.00" value={newTx.tournamentMoney} onChange={handleInputChange} className="input-field" />
                        </div>
                        <div className="col-span-1">
                            <label className="label">Instant Bonus (+)</label>
                            <input type="number" name="instantBonus" placeholder="0.00" value={newTx.instantBonus} onChange={handleInputChange} className="input-field" />
                        </div>
                        <div className="col-span-1">
                            <label className="label">Locked Bonus (+)</label>
                            <input type="number" name="lockedBonus" placeholder="0.00" value={newTx.lockedBonus} onChange={handleInputChange} className="input-field" />
                        </div>
                        <div className="col-span-1">
                            <label className="label">Other (+/-)</label>
                            <input type="number" name="other" placeholder="0.00" value={newTx.other} onChange={handleInputChange} className="input-field" />
                        </div>
                        <div className="col-span-full flex justify-end">
                            <button type="submit" className="btn-primary w-full md:w-auto">Add Transaction</button>
                        </div>
                    </form>

                    <h2 className="text-2xl font-bold mt-8">All Transactions</h2>
                    <div className="overflow-x-auto bg-gray-800 rounded-lg">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-700 text-xs uppercase">
                                <tr>
                                    {['date', 'pokerSite', 'deposit', 'withdrawal', 'tax', 'tournamentMoney', 'instantBonus', 'lockedBonus', 'other', 'newBankroll'].map(key => (
                                        <th key={key} scope="col" className="p-3 cursor-pointer" onClick={() => requestSort(key)}>
                                            {key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())} <span className="text-gray-400">{getSortIndicator(key)}</span>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {sortedTransactions.map(tx => {
                                    const site = pokerSites.find(s => s.name === tx.pokerSite) || { currency: '' };
                                    return (
                                        <tr key={tx.id} className="border-b border-gray-700 hover:bg-gray-700">
                                            <td className="p-3">{tx.date}</td>
                                            <td className="p-3">{tx.pokerSite}</td>
                                            <td className="p-3">{renderValue(tx.deposit)}</td>
                                            <td className="p-3">{renderValue(-tx.withdrawal)}</td>
                                            <td className="p-3">{renderValue(-tx.tax)}</td>
                                            <td className="p-3">{renderValue(tx.tournamentMoney)}</td>
                                            <td className="p-3">{renderValue(tx.instantBonus)}</td>
                                            <td className="p-3">{renderValue(tx.lockedBonus)}</td>
                                            <td className="p-3">{renderValue(tx.other)}</td>
                                            <td className="p-3 font-semibold">{formatCurrency(tx.newBankroll, site.currency)}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- TOURNAMENTS VIEW & COMPLETED TOURNAMENTS VIEW ---
        const TournamentTable = ({ tournaments, setTournaments, pokerSites, gameTypes, gameFormats, gameStructures, isResultsView = false }) => {
            const [sortConfig, setSortConfig] = useState({ key: 'id', direction: 'descending' });
            const [selectedIds, setSelectedIds] = useState(new Set());
            const [modal, setModal] = useState({ isOpen: false, type: '', data: null });

            const handleSelectAll = (e) => {
                if (e.target.checked) {
                    const allIds = processedTournaments.map(t => t.id);
                    setSelectedIds(new Set(allIds));
                } else {
                    setSelectedIds(new Set());
                }
            };

            const handleSelectOne = (id) => {
                setSelectedIds(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(id)) {
                        newSet.delete(id);
                    } else {
                        newSet.add(id);
                    }
                    return newSet;
                });
            };

            const handleDelete = (idsToDelete) => {
                if (!window.confirm(`Are you sure you want to delete ${idsToDelete.length} tournament(s)?`)) return;
                setTournaments(prev => prev.filter(t => !idsToDelete.includes(t.id)));
                if (idsToDelete.length > 1) setSelectedIds(new Set());
            };

            const handleClearUncompleted = () => {
                if (!window.confirm('Are you sure you want to delete ALL uncompleted tournaments? This cannot be undone.')) return;
                setTournaments(prev => prev.filter(t => t.entries !== null));
            };

            const openModal = (type, tournament = null) => {
                let initialData = {
                    entries: '', addon: 0, bountyCashout: 0, itmCashout: 0, tournamentMoneyCashout: 0, finishPosition: ''
                };

                if (tournament && type === 'edit') {
                    Object.keys(initialData).forEach(key => {
                        initialData[key] = tournament[key] || initialData[key];
                    });
                }

                setModal({ isOpen: true, type, data: tournament, formData: initialData });
            };

            const handleUpdateResult = (formData) => {
                setTournaments(prev => prev.map(t => {
                    if (t.id === modal.data.id) {
                        return {
                            ...t,
                            entries: parseInt(formData.entries),
                            addon: parseFloat(formData.addon) || 0,
                            bountyCashout: parseFloat(formData.bountyCashout) || 0,
                            itmCashout: parseFloat(formData.itmCashout) || 0,
                            tournamentMoneyCashout: parseFloat(formData.tournamentMoneyCashout) || 0,
                            finishPosition: formData.finishPosition ? parseInt(formData.finishPosition) : null,
                        };
                    }
                    return t;
                }));
                setModal({ isOpen: false, type: '', data: null });
            };

            const getTournamentStatus = (tournament) => {
                if (tournament.entries !== null) {
                    return { status: 'Completed', color: 'text-purple-400' };
                }
                const now = new Date();
                const startTime = new Date(`${tournament.date}T${tournament.time}:00`);
                const diffMs = startTime - now;
                if (diffMs > 0) {
                    if (diffMs <= 60 * 60 * 1000) {
                        return { status: 'Starting Soon', color: 'text-yellow-400' };
                    } else {
                        return { status: 'Upcoming', color: 'text-gray-400' };
                    }
                } else {
                    const elapsedMs = -diffMs;
                    if (elapsedMs <= 60 * 60 * 1000) {
                        return { status: 'Just Started', color: 'text-green-400' };
                    } else {
                        return { status: 'In Progress', color: 'text-blue-400' };
                    }
                }
            };

            const processedTournaments = useMemo(() => {
                let items = isResultsView ? tournaments.filter(t => t.entries !== null) : tournaments;

                items = items.map(t => {
                    const netBuyIn = (t.buyIn - (t.buyInDiscount || 0)) + (t.addon || 0);
                    const totalCashout = (t.bountyCashout || 0) + (t.itmCashout || 0);
                    const profitLoss = totalCashout - netBuyIn;
                    const roi = netBuyIn > 0 ? (profitLoss / netBuyIn) * 100 : 0;
                    return { ...t, netBuyIn, totalCashout, profitLoss, roi };
                });

                if (sortConfig.key) {
                    items.sort((a, b) => {
                        const valA = a[sortConfig.key];
                        const valB = b[sortConfig.key];
                        if (valA < valB) return sortConfig.direction === 'ascending' ? -1 : 1;
                        if (valA > valB) return sortConfig.direction === 'ascending' ? 1 : -1;
                        return 0;
                    });
                }
                return items;
            }, [tournaments, sortConfig, isResultsView]);

            const requestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') direction = 'descending';
                setSortConfig({ key, direction });
            };
            const getSortIndicator = (key) => sortConfig.key === key ? (sortConfig.direction === 'ascending' ? 'â–²' : 'â–¼') : 'â†•';

            const headers = [
                { key: 'date', label: 'Date' },
            ];
            if (!isResultsView) {
                headers.push({ key: 'status', label: 'Status', sortable: false });
            }
            headers.push(
                { key: 'name', label: 'Name' },
                { key: 'pokerSite', label: 'Site' },
                { key: 'buyIn', label: 'Buy-in' },
                { key: 'gtd', label: 'GTD' },
                { key: 'entries', label: 'Entries' },
            );
            if (isResultsView) {
                headers.push(
                    { key: 'finishPosition', label: 'Finish' },
                    { key: 'totalCashout', label: 'Cashout' },
                    { key: 'profitLoss', label: 'Profit/Loss' },
                    { key: 'roi', label: 'ROI (%)' }
                );
            }
            headers.push({ key: 'actions', label: 'Actions', sortable: false });

            return (
                <div>
                    {!isResultsView && (
                        <div className="mb-4 flex flex-wrap gap-2 items-center">
                            <button onClick={() => handleDelete(Array.from(selectedIds))} disabled={selectedIds.size === 0} className="btn-danger">Delete Selected</button>
                            <button onClick={handleClearUncompleted} className="btn-secondary">Clear Uncompleted MTTs</button>
                        </div>
                    )}
                    <div className="overflow-x-auto bg-gray-800 rounded-lg">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-700 text-xs uppercase">
                                <tr>
                                    <th scope="col" className="p-2">
                                        <input type="checkbox" onChange={handleSelectAll} className="checkbox"/>
                                    </th>
                                    {headers.map(h => (
                                        <th key={h.key} scope="col" className="p-3" onClick={() => h.sortable !== false && requestSort(h.key)}>
                                            <span className={h.sortable !== false ? 'cursor-pointer' : ''}>
                                                {h.label} {h.sortable !== false && <span className="text-gray-400">{getSortIndicator(h.key)}</span>}
                                            </span>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {processedTournaments.map(t => {
                                    const site = pokerSites.find(s => s.name === t.pokerSite) || { currency: '' };
                                    const isCompleted = t.entries !== null;
                                    let rowColor = '';
                                    if (isCompleted) {
                                        rowColor = t.profitLoss > 0 ? 'bg-green-900 bg-opacity-30 hover:bg-green-800' : 'bg-red-900 bg-opacity-30 hover:bg-red-800';
                                    } else {
                                        rowColor = 'hover:bg-gray-700';
                                    }
                                    const status = !isResultsView ? getTournamentStatus(t) : null;

                                    return (
                                        <tr key={t.id} className={`border-b border-gray-700 ${rowColor}`}>
                                            <td className="p-2"><input type="checkbox" checked={selectedIds.has(t.id)} onChange={() => handleSelectOne(t.id)} className="checkbox"/></td>
                                            <td className="p-3">{t.date}</td>
                                            {!isResultsView && <td className="p-3"><span className={status.color}>{status.status}</span></td>}
                                            <td className="p-3 font-medium">{t.name}</td>
                                            <td className="p-3">{t.pokerSite}</td>
                                            <td className="p-3">{formatCurrency(t.buyIn, site.currency)}</td>
                                            <td className="p-3">{formatCurrency(t.gtd, site.currency)}</td>
                                            <td className="p-3">{t.entries || '-'}</td>
                                            {isResultsView && (
                                                <>
                                                    <td className="p-3">{t.finishPosition || '-'}</td>
                                                    <td className="p-3">{formatCurrency(t.totalCashout, site.currency)}</td>
                                                    <td className={`p-3 font-semibold ${t.profitLoss > 0 ? 'text-green-400' : t.profitLoss < 0 ? 'text-red-400' : ''}`}>{formatCurrency(t.profitLoss, site.currency)}</td>
                                                    <td className={`p-3 font-semibold ${t.roi > 0 ? 'text-green-400' : t.roi < 0 ? 'text-red-400' : ''}`}>{t.roi.toFixed(2)}%</td>
                                                </>
                                            )}
                                            <td className="p-3 flex gap-2">
                                                {!isCompleted ? (
                                                    <button onClick={() => openModal('update', t)} className="btn-action-primary">Update Result</button>
                                                ) : (
                                                    <>
                                                        <button onClick={() => openModal('edit', t)} className="btn-action-secondary">Edit</button>
                                                        <button onClick={() => openModal('view', t)} className="btn-action-secondary">View</button>
                                                    </>
                                                )}
                                                <button onClick={() => handleDelete([t.id])} className="btn-action-danger">Del</button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    {/* --- Modals --- */}
                    {modal.isOpen && modal.type === 'view' && (
                        <Modal isOpen={modal.isOpen} onClose={() => setModal({isOpen: false})} title={`View: ${modal.data.name}`}>
                            <div className="space-y-2 text-gray-300">
                                {Object.entries(modal.data).map(([key, value]) => (
                                    <div key={key} className="grid grid-cols-2">
                                        <strong className="capitalize text-gray-100">{key.replace(/([A-Z])/g, ' $1')}:</strong>
                                        <span>{value === null ? 'N/A' : String(value)}</span>
                                    </div>
                                ))}
                            </div>
                        </Modal>
                    )}
                    {modal.isOpen && (modal.type === 'update' || modal.type === 'edit') && (
                        <UpdateResultModal modal={modal} setModal={setModal} onSave={handleUpdateResult} />
                    )}
                </div>
            );
        };

        const UpdateResultModal = ({ modal, setModal, onSave }) => {
            const [formData, setFormData] = useState(modal.formData);

            const handleChange = e => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = e => {
                e.preventDefault();
                if (!formData.entries) {
                    alert('Entries field is mandatory to complete a tournament.');
                    return;
                }
                onSave(formData);
            };

            const fields = [
                { name: 'entries', label: 'Total Entries', type: 'number', required: true },
                { name: 'finishPosition', label: 'Finish Position', type: 'number' },
                { name: 'itmCashout', label: 'ITM Cashout', type: 'number' },
                { name: 'bountyCashout', label: 'Bounty Cashout', type: 'number' },
                { name: 'addon', label: 'Add-on / Re-entry Cost', type: 'number' },
                { name: 'tournamentMoneyCashout', label: 'Tournament Money Won', type: 'number' },
            ];

            return (
                <Modal isOpen={modal.isOpen} onClose={() => setModal({isOpen: false})} title={`${modal.type === 'update' ? 'Update' : 'Edit'} Result for: ${modal.data.name}`}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            {fields.map(f => (
                                <div key={f.name}>
                                    <label className="label">{f.label}{f.required && ' *'}</label>
                                    <input
                                        type={f.type}
                                        name={f.name}
                                        value={formData[f.name]}
                                        onChange={handleChange}
                                        className="input-field"
                                        placeholder="0"
                                        required={f.required}
                                    />
                                </div>
                            ))}
                        </div>
                        <div className="flex justify-end gap-2 pt-4">
                            <button type="button" onClick={() => setModal({isOpen: false})} className="btn-secondary">Cancel</button>
                            <button type="submit" className="btn-primary">Save Result</button>
                        </div>
                    </form>
                </Modal>
            );
        };

        const TournamentsView = (props) => {
            const { tournaments, setTournaments, pokerSites, gameTypes, gameFormats, gameStructures } = props;
            const [newMtt, setNewMtt] = useState({
                date: getTodayDate(), time: getNowTime(), pokerSite: pokerSites[0]?.name || '',
                buyIn: '', buyInDiscount: 0, gtd: '', gameType: gameTypes[0] || '', gameFormat: gameFormats[0] || '', gameStructure: gameStructures[0] || ''
            });

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setNewMtt(prev => ({...prev, [name]: value}));
            };

            const handleAddTournament = (e) => {
                e.preventDefault();
                const { date, pokerSite, buyIn, gtd, gameType, gameFormat, gameStructure, time } = newMtt;
                const buyInNum = parseFloat(buyIn);

                if (!pokerSite || !buyIn || !gtd) return;

                const site = pokerSites.find(s => s.name === pokerSite);
                const day = new Date(date).toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();

                const newTournament = {
                    id: Date.now(),
                    date, time, pokerSite, gameType, gameFormat, gameStructure,
                    buyIn: buyInNum,
                    buyInDiscount: parseFloat(newMtt.buyInDiscount) || 0,
                    gtd: parseFloat(gtd),
                    name: `${day}-${pokerSite}-${formatCurrency(buyInNum, site?.currency || 'INR')}`,
                    entries: null, addon: 0, bountyCashout: 0, itmCashout: 0, tournamentMoneyCashout: 0, finishPosition: null
                };

                setTournaments(prev => [...prev, newTournament]);
            };

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold">Add New Tournament</h2>
                    <form onSubmit={handleAddTournament} className="bg-gray-800 p-4 rounded-lg grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        <div><label className="label">Date</label><input type="date" name="date" value={newMtt.date} onChange={handleInputChange} className="input-field" required/></div>
                        <div><label className="label">Time</label><input type="time" name="time" value={newMtt.time} onChange={handleInputChange} className="input-field" required/></div>
                        <div><label className="label">Poker Site</label><select name="pokerSite" value={newMtt.pokerSite} onChange={handleInputChange} className="input-field" required><option value="">Select Site</option>{pokerSites.map(s=><option key={s.id} value={s.name}>{s.name}</option>)}</select></div>
                        <div><label className="label">Buy-In</label><input type="number" name="buyIn" placeholder="5000" value={newMtt.buyIn} onChange={handleInputChange} className="input-field" required/></div>
                        <div><label className="label">Buy-In Discount</label><input type="number" name="buyInDiscount" placeholder="0" value={newMtt.buyInDiscount} onChange={handleInputChange} className="input-field"/></div>
                        <div><label className="label">GTD</label><input type="number" name="gtd" placeholder="1000000" value={newMtt.gtd} onChange={handleInputChange} className="input-field" required/></div>
                        <div><label className="label">Game Type</label><select name="gameType" value={newMtt.gameType} onChange={handleInputChange} className="input-field" required>{gameTypes.map(gt=><option key={gt} value={gt}>{gt}</option>)}</select></div>
                        <div><label className="label">Game Format</label><select name="gameFormat" value={newMtt.gameFormat} onChange={handleInputChange} className="input-field" required>{gameFormats.map(gf=><option key={gf} value={gf}>{gf}</option>)}</select></div>
                        <div><label className="label">Game Structure</label><select name="gameStructure" value={newMtt.gameStructure} onChange={handleInputChange} className="input-field" required>{gameStructures.map(gs=><option key={gs} value={gs}>{gs}</option>)}</select></div>
                        <div className="col-span-full flex justify-end">
                            <button type="submit" disabled={!newMtt.pokerSite || !newMtt.buyIn || !newMtt.gtd} className="btn-primary w-full md:w-auto">Add Tournament</button>
                        </div>
                    </form>
                    <h2 className="text-2xl font-bold mt-8">All Tournaments</h2>
                    <TournamentTable {...props} />
                </div>
            );
        };

        const CompletedTournamentsView = (props) => (
            <div className="space-y-6">
                <h2 className="text-2xl font-bold">Completed Tournaments</h2>
                <p className="text-gray-400">This table shows only completed tournaments. You can view, edit, or delete them here.</p>
                <TournamentTable {...props} isResultsView={true} />
            </div>
        );

        // --- DASHBOARD VIEW ---
        const DashboardView = ({ tournaments, transactions, pokerSites }) => {
            const [expandedCards, setExpandedCards] = useState({});

            const toggleCard = (siteName) => {
                setExpandedCards(prev => ({...prev, [siteName]: !prev[siteName]}));
            };

            const dashboardData = useMemo(() => {
                const completedTournaments = tournaments.filter(t => t.entries !== null);
                let overall = {
                    totalBankroll: 0, totalProfitLoss: 0, totalNetBuyIns: 0,
                    avgBuyIn: 0, completedCount: completedTournaments.length, roi: 0
                };

                const perSite = pokerSites.map(site => {
                    const lastTx = transactions.filter(t => t.pokerSite === site.name).sort((a,b) => b.id - a.id)[0];
                    const bankroll = lastTx ? lastTx.newBankroll : 0;

                    const siteTxs = transactions.filter(t => t.pokerSite === site.name);
                    const txOverview = siteTxs.reduce((acc, tx) => {
                        acc.deposits += tx.deposit || 0;
                        acc.withdrawals += tx.withdrawal || 0;
                        acc.taxes += tx.tax || 0;
                        acc.bonuses += (tx.instantBonus || 0) + (tx.lockedBonus || 0) + (tx.tournamentMoney || 0);
                        acc.other += tx.other || 0;
                        return acc;
                    }, { deposits: 0, withdrawals: 0, taxes: 0, bonuses: 0, other: 0});

                    const siteMtts = completedTournaments.filter(t => t.pokerSite === site.name);
                    let totalNetBuyIns = 0;
                    let totalCashouts = 0;
                    siteMtts.forEach(t => {
                        totalNetBuyIns += (t.buyIn - (t.buyInDiscount || 0)) + (t.addon || 0);
                        totalCashouts += (t.itmCashout || 0) + (t.bountyCashout || 0);
                    });
                    const profitLoss = totalCashouts - totalNetBuyIns;
                    const roi = totalNetBuyIns > 0 ? (profitLoss / totalNetBuyIns) * 100 : 0;
                    const avgBuyIn = siteMtts.length > 0 ? totalNetBuyIns / siteMtts.length : 0;

                    const rate = EXCHANGE_RATES[site.currency] || 1;
                    overall.totalBankroll += bankroll * rate;
                    overall.totalNetBuyIns += totalNetBuyIns * rate;
                    overall.totalProfitLoss += profitLoss * rate;

                    return {
                        ...site,
                        bankroll, profitLoss, roi, avgBuyIn,
                        completedCount: siteMtts.length, txOverview
                    };
                });

                overall.roi = overall.totalNetBuyIns > 0 ? (overall.totalProfitLoss / overall.totalNetBuyIns) * 100 : 0;
                overall.avgBuyIn = overall.completedCount > 0 ? overall.totalNetBuyIns / overall.completedCount : 0;

                return { overall, perSite };
            }, [tournaments, transactions, pokerSites]);

            const StatCard = ({ title, value, color = 'text-white' }) => (
                <div className="bg-gray-700 p-4 rounded-lg text-center">
                    <p className="text-sm text-gray-400">{title}</p>
                    <p className={`text-2xl font-bold ${color}`}>{value}</p>
                </div>
            );

            return (
                <div className="space-y-8">
                    <div>
                        <h2 className="text-2xl font-bold mb-4">Overall Performance (INR Equivalent)</h2>
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                            <StatCard title="Total Bankroll" value={formatCurrency(dashboardData.overall.totalBankroll, 'INR')} />
                            <StatCard
                                title="Total Profit/Loss"
                                value={formatCurrency(dashboardData.overall.totalProfitLoss, 'INR')}
                                color={dashboardData.overall.totalProfitLoss > 0 ? 'text-green-400' : dashboardData.overall.totalProfitLoss < 0 ? 'text-red-400' : 'text-white'}
                            />
                            <StatCard
                                title="Overall ROI"
                                value={`${dashboardData.overall.roi.toFixed(2)}%`}
                                color={dashboardData.overall.roi > 0 ? 'text-green-400' : dashboardData.overall.roi < 0 ? 'text-red-400' : 'text-white'}
                            />
                            <StatCard title="Avg. Buy-In" value={formatCurrency(dashboardData.overall.avgBuyIn, 'INR')} />
                            <StatCard title="Completed MTTs" value={dashboardData.overall.completedCount} />
                        </div>
                    </div>

                    <div>
                        <h2 className="text-2xl font-bold mb-4">Per-Site Performance</h2>
                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {dashboardData.perSite.map(site => (
                                <div key={site.id} className="bg-gray-800 rounded-lg p-5 space-y-4">
                                    <h3 className="text-xl font-bold">{site.name}</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        <StatCard title="Current Bankroll" value={formatCurrency(site.bankroll, site.currency)} />
                                        <StatCard
                                            title="Profit/Loss (MTTs)"
                                            value={formatCurrency(site.profitLoss, site.currency)}
                                            color={site.profitLoss > 0 ? 'text-green-400' : site.profitLoss < 0 ? 'text-red-400' : 'text-white'}
                                        />
                                        <StatCard
                                            title="ROI (MTTs)"
                                            value={`${site.roi.toFixed(2)}%`}
                                            color={site.roi > 0 ? 'text-green-400' : site.roi < 0 ? 'text-red-400' : 'text-white'}
                                        />
                                        <StatCard title="Avg. Buy-In" value={formatCurrency(site.avgBuyIn, site.currency)} />
                                    </div>
                                    <div className="text-center text-sm text-gray-400">Completed MTTs: {site.completedCount}</div>

                                    <div className="pt-2">
                                        <button onClick={() => toggleCard(site.name)} className="w-full text-left text-sm font-semibold text-gray-300 hover:text-white">
                                            Total Transactions Overview {expandedCards[site.name] ? 'âˆ’' : '+'}
                                        </button>
                                        <div className={`collapsible-content ${expandedCards[site.name] ? 'expanded' : ''} pt-2`}>
                                            <div className="text-xs space-y-1 text-gray-400 bg-gray-900 p-2 rounded">
                                                <p className="flex justify-between"><span>Deposits:</span> <span className="text-green-400">{formatCurrency(site.txOverview.deposits, site.currency)}</span></p>
                                                <p className="flex justify-between"><span>Withdrawals:</span> <span className="text-red-400">{formatCurrency(site.txOverview.withdrawals, site.currency)}</span></p>
                                                <p className="flex justify-between"><span>Taxes:</span> <span className="text-red-400">{formatCurrency(site.txOverview.taxes, site.currency)}</span></p>
                                                <p className="flex justify-between"><span>Bonuses/T-Money:</span> <span className="text-green-400">{formatCurrency(site.txOverview.bonuses, site.currency)}</span></p>
                                                <p className="flex justify-between"><span>Other:</span> <span>{formatCurrency(site.txOverview.other, site.currency)}</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [view, setView] = useState('dashboard');

            const [tournaments, setTournaments] = useLocalStorage('poker_tournaments', []);
            const [transactions, setTransactions] = useLocalStorage('poker_transactions', []);
            const [pokerSites, setPokerSites] = useLocalStorage('poker_sites', DEFAULT_POKER_SITES);
            const [gameTypes, setGameTypes] = useLocalStorage('poker_gameTypes', DEFAULT_GAME_TYPES);
            const [gameFormats, setGameFormats] = useLocalStorage('poker_gameFormats', DEFAULT_GAME_FORMATS);
            const [gameStructures, setGameStructures] = useLocalStorage('poker_gameStructures', DEFAULT_GAME_STRUCTURES);

            const commonProps = {
                tournaments, setTournaments,
                transactions, setTransactions,
                pokerSites, setPokerSites,
                gameTypes, setGameTypes,
                gameFormats, setGameFormats,
                gameStructures, setGameStructures,
            };

            const renderView = () => {
                switch (view) {
                    case 'tournaments': return <TournamentsView {...commonProps} />;
                    case 'transactions': return <TransactionsView {...commonProps} />;
                    case 'completed_tournaments': return <CompletedTournamentsView {...commonProps} />;
                    case 'manage': return <ManageView {...commonProps} />;
                    case 'dashboard':
                    default:
                        return <DashboardView {...commonProps} />;
                }
            };

            const NavItem = ({ viewName, currentView, setView, children }) => {
                const isActive = viewName === currentView;
                const classes = `px-4 py-2 text-sm font-medium rounded-md transition-colors ${isActive ? 'bg-indigo-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}`;
                return <button onClick={() => setView(viewName)} className={classes}>{children}</button>;
            };

            return (
                <div className="min-h-screen">
                    <nav className="bg-gray-800 shadow-md">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex items-center justify-between h-16">
                                <div className="flex items-center">
                                    <span className="text-white font-bold text-xl">Poker Manager</span>
                                </div>
                                <div className="flex items-baseline space-x-2">
                                    <NavItem viewName="dashboard" currentView={view} setView={setView}>Dashboard</NavItem>
                                    <NavItem viewName="tournaments" currentView={view} setView={setView}>Tournaments</NavItem>
                                    <NavItem viewName="transactions" currentView={view} setView={setView}>Transactions</NavItem>
                                    <NavItem viewName="completed_tournaments" currentView={view} setView={setView}>Completed Tournaments</NavItem>
                                    <NavItem viewName="manage" currentView={view} setView={setView}>Manage</NavItem>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main>
                        <div className="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                            {renderView()}
                        </div>
                    </main>

                    <style>{`
                        .input-field { @apply w-full bg-gray-700 text-white border border-gray-600 rounded-md shadow-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500; }
                        .label { @apply block text-sm font-medium text-gray-300 mb-1; }
                        .btn-primary { @apply bg-indigo-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed; }
                        .btn-secondary { @apply bg-gray-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-gray-500; }
                        .btn-danger { @apply bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed; }
                        .btn-action-primary { @apply text-xs bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded; }
                        .btn-action-secondary { @apply text-xs bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-2 rounded; }
                        .btn-action-danger { @apply text-xs bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded; }
                        .checkbox { @apply h-4 w-4 rounded bg-gray-700 border-gray-500 text-indigo-600 focus:ring-indigo-500; }
                    `}</style>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
